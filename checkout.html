<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Checkout & Payment</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background:#f7f7f7; }
        .container { max-width:700px; margin:20px auto; }
        .section-header { border-bottom:3px solid #ff6600; padding-bottom:6px; margin-top:30px; margin-bottom:15px; font-weight:700; color:#333;}
        .form-card { background:#fff; border-radius:12px; padding:25px; box-shadow:0 8px 20px rgba(0,0,0,.08); margin-bottom:20px;}
        input[type="text"], input[type="tel"], textarea, select { border:1px solid #ddd; border-radius:8px; padding:10px 12px; width:100%; }
        input:focus, textarea:focus, select:focus { border-color:#ff6600; box-shadow:0 0 0 2px rgba(255,102,0,0.15); outline:none; }
        .coupon-btn { background:#008000; }
        .select-btn { padding:12px; border:2px solid #ddd; border-radius:8px; cursor:pointer; background:#f0f0f0; font-weight:600;}
        .select-btn.active { border-color:#ff6600; background:#fff0e0; color:#ff6600; transform:scale(1.02); }
        .order-summary-table { width:100%; border-collapse:collapse; font-size:0.95rem;}
        .order-summary-table th, .order-summary-table td { padding:10px 0; border-bottom:1px solid #eee; }
        .total-row-summary td { font-weight:700; color:#ff6600; border-top:2px solid #ff6600; padding-top:15px !important;}
    </style>
</head>
<body>
    <header class="bg-white shadow-md">
        <div class="container flex justify-between items-center py-4 px-4">
            <h1 class="text-2xl font-bold text-orange-600">WideFind Checkout</h1>
            
            <a href="cart.html" id="back-to-cart-btn">
    â† Back to Cart
</a>

            
        </div>
    </header>

    <div class="container">
        <form id="order-form" class="form-card">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Complete Your Order</h2>
            <h3 class="section-header">Delivery & Contact Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium">Full Name</label><input id="name" type="text" required placeholder="Full name">
                </div>
                <div>
                    <label class="block text-sm font-medium">Phone Number</label><input id="phone" type="tel" required pattern="[0-9]{11}" placeholder="01XXXXXXXXX">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium">Region</label>
                    <select id="region" required><option value="">Select Region</option></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">District</label>
                    <select id="district" required disabled><option value="">Select District</option></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">Upazila</label>
                    <select id="upazila" required disabled><option value="">Select Upazila</option></select>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium">Full Delivery Address</label>
                <textarea id="address" rows="2" required placeholder="Apartment, suite, unit..."></textarea>
            </div>

            <h3 class="section-header">Coupon Code</h3>
            <div class="flex gap-3 mb-6">
                <div class="flex-grow">
                    <label class="block text-sm font-medium">Enter Code</label>
                    <input id="coupon-code" type="text" placeholder="Enter coupon code">
                    <p id="coupon-status" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <button type="button" id="apply-coupon-btn" class="coupon-btn text-white px-5 py-3 rounded-lg">Apply</button>
            </div>

            <h3 class="section-header">Order & Price Summary</h3>
            <div class="mb-6">
                <table class="order-summary-table">
                    <thead><tr><th class="w-2/3">Item / Description</th><th class="w-1/3 text-right">Amount (à§³)</th></tr></thead>
                    <tbody id="cart-summary-body"><tr><td colspan="2" class="text-center text-gray-500 italic p-4">Cart is loading or empty...</td></tr></tbody>
                    <tfoot id="price-summary-foot"></tfoot>
                </table>
            </div>

            <h3 class="section-header">Payment Method</h3>
            <div class="flex gap-3 mb-6">
                <button type="button" class="select-btn flex-1 active" data-method="Cash on Delivery">Cash on Delivery (COD)</button>
                <button type="button" class="select-btn flex-1" data-method="Online Payment">Bkash / Nagad </button>
            </div>
            <input type="hidden" id="payment-method" value="Cash on Delivery">

            <div id="online-payment-fields" class="border-2 border-dashed border-orange-300 bg-red-50 p-4 rounded-lg hidden">
                <p class="text-lg font-bold text-red-600 mb-3">Complete Mobile Payment</p>
                <div class="p-3 bg-red-100 rounded-lg mb-4 text-center">
                    <span class="text-xl font-extrabold text-orange-600">01729789847</span> <span class="text-gray-600 font-semibold">(Bkash/Nagad Merchant)</span>
                </div>
                <div class="flex gap-3 mb-4">
                    <button type="button" class="select-btn flex-1 bg-pink-100 border-pink-500 text-pink-600" data-channel="Bkash">Bkash</button>
                    <button type="button" class="select-btn flex-1 bg-purple-100 border-purple-500 text-purple-600" data-channel="Nagad">Nagad</button>
                </div>
                <input type="hidden" id="payment-channel" value="">
                <label class="block text-sm font-medium mt-3">Your Mobile Number (Sender)</label><input id="sender-number" type="text" placeholder="01XXXXXXXXX">
                <label class="block text-sm font-medium mt-3">Transaction ID</label><input id="transaction-id" type="text" placeholder="ABC123XYZ">
            </div>

            <div class="flex gap-4 mt-8">
                <button type="submit" id="place-order-btn" class="flex-1 bg-orange-600 text-white p-4 rounded-xl font-bold">Place Order</button>
                <button type="button" id="cancel-order-btn" class="flex-1 bg-red-600 text-white p-4 rounded-xl font-bold">Cancel Order</button>
            </div>
        </form>
    </div>

    <!-- Firebase + logic -->
    
    
    
    
    
    
 <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ---------------- Firebase Setup ---------------- */
const firebaseConfig = {
Â  apiKey: "AIzaSyDFsnU6n1-ag1XB8QgJcj5rqjWHxaJ71v8",
Â  authDomain: "my-ecom-site-168ab.firebaseapp.com",
Â  projectId: "my-ecom-site-168ab",
Â  storageBucket: "my-ecom-site-168ab.firebasestorage.app",
Â  messagingSenderId: "995581566071",
Â  appId: "1:995581566071:web:1640d0236302d369aefa72",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------------- Constants & Elements ---------------- */
const DELIVERY_FEES = 80;
const CART_STORAGE_KEY = "widefindCart";
const SUCCESS_REDIRECT_URL = "index.html";

const regionEl = document.getElementById("region");
const districtEl = document.getElementById("district");
const upazilaEl = document.getElementById("upazila");
const applyCouponBtn = document.getElementById("apply-coupon-btn");
const couponInput = document.getElementById("coupon-code");
const couponStatus = document.getElementById("coupon-status");
const placeOrderBtn = document.getElementById("place-order-btn");
const cancelOrderBtn = document.getElementById("cancel-order-btn");
const cartSummaryBody = document.getElementById("cart-summary-body");
const priceSummaryFoot = document.getElementById("price-summary-foot");

// --- Global Data Holders ---
let GEO_DATA = {};
let cartItems = [];
let availableCoupons = [];
let appliedCoupon = null;
let currentDiscount = 0;

/* ---------------- HQ Animated Alert ---------------- */
function showAlert(type, msg) {
Â  const box = document.createElement("div");
Â  box.className =
Â  Â  "fixed top-5 right-5 z-50 flex items-center gap-3 px-5 py-3 rounded-xl text-white font-semibold shadow-xl backdrop-blur-md transition-all duration-500 transform scale-95 opacity-0";
Â  box.innerHTML =
Â  Â  type === "success"
Â  Â  Â  ? `<svg class='w-6 h-6 text-white animate-bounce' fill='none' stroke='currentColor' stroke-width='3' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' d='M5 13l4 4L19 7'/></svg><span>${msg}</span>`
Â  Â  Â  : `<svg class='w-6 h-6 text-white animate-pulse' fill='none' stroke='currentColor' stroke-width='3' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' d='M6 18L18 6M6 6l12 12'/></svg><span>${msg}</span>`;
Â  box.style.background =
Â  Â  type === "success"
Â  Â  Â  ? "linear-gradient(90deg,#10B981,#34D399)"
Â  Â  Â  : "linear-gradient(90deg,#EF4444,#F87171)";
Â  document.body.appendChild(box);
Â  setTimeout(() => {
Â  Â  box.style.opacity = "1";
Â  Â  box.style.transform = "scale(1)";
Â  }, 50);
Â  setTimeout(() => {
Â  Â  box.style.opacity = "0";
Â  Â  box.style.transform = "scale(0.95)";
Â  Â  setTimeout(() => box.remove(), 400);
Â  }, 3000);
}

/* ---------------- Geo Data Loader ---------------- */
fetch("geo_data.json")
Â  .then(res => res.json())
Â  .then(data => {
Â  Â  GEO_DATA = data;
Â  Â  populateRegions();
Â  })
Â  .catch(err => console.error("Failed to load geo_data:", err));

function populateRegions() {
Â  regionEl.innerHTML = '<option value="" disabled selected>Select Region</option>';
Â  Object.keys(GEO_DATA).forEach(r => {
Â  Â  const o = document.createElement("option");
Â  Â  o.value = r;
Â  Â  o.textContent = r;
Â  Â  regionEl.appendChild(o);
Â  });
}
function populateDistricts() {
Â  districtEl.innerHTML = '<option value="" disabled selected>Select District</option>';
Â  upazilaEl.innerHTML = '<option value="" disabled selected>Select Upazila</option>';
Â  upazilaEl.disabled = true;
Â  const sel = regionEl.value;
Â  if (!sel) { districtEl.disabled = true; return; }
Â  districtEl.disabled = false;
Â  Object.keys(GEO_DATA[sel]).forEach(d => {
Â  Â  const o = document.createElement("option");
Â  Â  o.value = d; o.textContent = d;
Â  Â  districtEl.appendChild(o);
Â  });
}
function populateUpazilas() {
Â  upazilaEl.innerHTML = '<option value="" disabled selected>Select Upazila</option>';
Â  const selR = regionEl.value;
Â  const selD = districtEl.value;
Â  if (!selR || !selD) { upazilaEl.disabled = true; return; }
Â  upazilaEl.disabled = false;
Â  GEO_DATA[selR][selD].forEach(u => {
Â  Â  const o = document.createElement("option");
Â  Â  o.value = u; o.textContent = u;
Â  Â  upazilaEl.appendChild(o);
Â  });
}
regionEl.addEventListener("change", populateDistricts);
districtEl.addEventListener("change", populateUpazilas);

/* ---------------- Cart + Coupon Logic ---------------- */
function getCart() {
Â  try {
Â  Â  return JSON.parse(localStorage.getItem(CART_STORAGE_KEY)) || [];
Â  } catch { return []; }
}


async function loadCouponsFromFirestore() {
Â  try {
Â  Â  const ref = doc(db, "artifacts/WideFind/public/data/config/coupons");
Â  Â  const snap = await getDoc(ref);
Â  Â  availableCoupons = snap.exists() ? snap.data().validCodes || [] : [];
Â  Â  console.log("âœ… Coupons loaded:", availableCoupons);
Â  } catch (err) {
Â  Â  console.error("Error loading coupons:", err);
Â  Â  availableCoupons = [];
Â  }
}

function findMatchingCoupon(code) {
Â  return availableCoupons.find(c => c.code && c.code.toUpperCase() === code.toUpperCase());
}
function couponAppliesToCart(coupon, cart) {
Â  if (!coupon) return false;
Â  if (!coupon.allowedProducts || !coupon.allowedProducts.length) return true;
Â  return cart.some(i => coupon.allowedProducts.includes(i.sku));
}
function computeDiscount(coupon, total) {
Â  if (!coupon) return 0;
Â  return coupon.type === "percent"
Â  Â  ? Math.round(total * (coupon.amount / 100))
Â  Â  : coupon.amount;
}

function applyCouponClientSide(code) {
Â  couponStatus.textContent = "";
Â  const coupon = findMatchingCoupon(code);
Â Â 
Â  if (!coupon) return (couponStatus.textContent = "Invalid or expired coupon.");
Â Â 
Â  // Calculate the total cost of products (excluding shipping)
Â  const productTotal = cartItems.reduce((s,i)=>s+(i.price*i.qty),0);
Â Â 
Â  // âœ… NEW CHECK FOR MINIMUM SPEND REQUIREMENT
Â  const minRequired = coupon.minSpendRequired || 0; // Safely get minSpendRequired, defaulting to 0
Â  if (productTotal < minRequired) {
Â  Â  // If the cart total is too low, reject the coupon and show the required amount.
Â  Â  appliedCoupon = null;
Â  Â  currentDiscount = 0;
Â  Â  renderOrderSummary(); // Update summary to show 0 discount
Â  Â  return (couponStatus.textContent = `âŒ Minimum spent of à§³${minRequired} is required.`);
Â  }
Â Â 
Â  if (!couponAppliesToCart(coupon, cartItems))
Â  Â  return (couponStatus.textContent = "Coupon not valid for these items.");
Â Â 
Â  // If all checks pass, apply the discount
Â  currentDiscount = computeDiscount(coupon, productTotal);
Â  appliedCoupon = coupon;
Â  couponStatus.textContent = `âœ… Coupon ${coupon.code} applied â€” saved à§³${currentDiscount}`;
Â  showAlert("success", `Coupon ${coupon.code} applied!`);
}

applyCouponBtn.addEventListener("click", async () => {
Â  applyCouponBtn.disabled = true;
Â  applyCouponBtn.innerHTML =
Â  Â  `<svg class="animate-spin h-5 w-5 mr-2 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
Â  Â  Â  Â <circle class="opacity-25" cx="12" cy="12" r="10" stroke="white" stroke-width="4"></circle>
Â  Â  Â  Â <path class="opacity-75" fill="white" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
Â  Â  Â </svg> Applying...`;

Â  // Refresh coupons from Firestore (in case admin changed them)
Â  await loadCouponsFromFirestore();

Â  const code = couponInput.value.trim();

Â  // Attempt to apply coupon; applyCouponClientSide sets currentDiscount or leaves it 0
Â  applyCouponClientSide(code);

Â  // IMPORTANT: re-render the order summary so Discount & Grand Total update immediately
Â  renderOrderSummary();

Â  // Enable button again after short delay to keep UX smooth
Â  setTimeout(() => {
Â  Â  applyCouponBtn.disabled = false;
Â  Â  applyCouponBtn.textContent = "Apply";
Â  }, 1000);
});




/* ---------------- Initialize checkout ---------------- */
document.addEventListener('DOMContentLoaded', async () => {
Â  // Load cart from localStorage
Â  cartItems = getCart();
Â  console.log("DEBUG: checkout cartItems:", cartItems);

Â  // If cart is empty, inform user and redirect back to cart page
Â  if (!cartItems.length) {
Â  Â  showAlert("error", "ğŸ›’ Your cart is empty â€” you will be returned to Cart.");
Â  Â  setTimeout(() => (window.location.href = "cart.html"), 1800);
Â  Â  return;
Â  }

Â  // Ensure geo data is available before populating regions
Â  if (Object.keys(GEO_DATA).length) {
Â  Â  populateRegions();
Â  } else {
Â  Â  try {
Â  Â  Â  const res = await fetch("geo_data.json");
Â  Â  Â  GEO_DATA = await res.json();
Â  Â  Â  populateRegions();
Â  Â  } catch (err) {
Â  Â  Â  console.error("Geo data failed:", err);
Â  Â  Â  showAlert("error", "âš ï¸ Could not load delivery regions.");
Â  Â  }
Â  }

Â  // Render the order summary now that cartItems is ready
Â  renderOrderSummary();

Â  // Load coupons (background)
Â  await loadCouponsFromFirestore();
});





/* ---------------- Dynamic Totals & Summary ---------------- */

// base delivery fees by region (you can adjust values)
const DELIVERY_FEES_BY_REGION = {
Â  Dhaka: 80,
Â  Chattogram: 100,
Â  Rajshahi: 120,
Â  Khulna: 120,
Â  Sylhet: 110,
Â  Rangpur: 130,
Â  Barishal: 130,
Â  Mymensingh: 120,
};

// get delivery fee based on selected region
function getDeliveryFee() {
Â  const region = regionEl.value;
Â  return DELIVERY_FEES_BY_REGION[region] || 80; // default 80
}

// compute all totals
function calculateTotals() {
Â  const productTotal = cartItems.reduce(
Â  Â  (sum, item) => sum + (Number(item.price) || 0) * (Number(item.qty) || 0),
Â  Â  0
Â  );
Â  const deliveryFee = getDeliveryFee();
Â  const discount = currentDiscount || 0;
Â  const grandTotal = Math.max(productTotal + deliveryFee - discount, 0);
Â  return { productTotal, deliveryFee, discount, grandTotal };
}

// render summary table
function renderOrderSummary() {
Â  if (!cartItems.length) {
Â  Â  cartSummaryBody.innerHTML =
Â  Â  Â  '<tr><td colspan="2" class="text-center text-gray-500 italic p-4">Cart is empty.</td></tr>';
Â  Â  priceSummaryFoot.innerHTML = "";
Â  Â  return;
Â  }

Â  cartSummaryBody.innerHTML = cartItems
Â  Â  .map(
Â  Â  Â  (i) => `
Â  Â  Â  <tr>
Â  Â  Â  Â  <td>${i.name} <span class="text-xs text-gray-500">x${i.qty}</span></td>
Â  Â  Â  Â  <td class="text-right">à§³${(i.price * i.qty).toFixed(0)}</td>
Â  Â  Â  </tr>`
Â  Â  )
Â  Â  .join("");

Â  const { productTotal, deliveryFee, discount, grandTotal } = calculateTotals();

Â  // âœ… Includes Pathao courier service notice
Â  priceSummaryFoot.innerHTML = `
Â  Â  <tr><td class="text-gray-600 pt-2">Product Total</td><td class="text-right text-gray-600 pt-2">à§³${productTotal.toFixed(0)}</td></tr>
Â  Â  <tr>
Â  Â  Â  <td class="text-gray-600">Delivery Fee</td>
Â  Â  Â  <td class="text-right text-gray-600">à§³${deliveryFee.toFixed(0)}</td>
Â  Â  </tr>
Â  Â  <tr>
Â  Â  Â  <td colspan="2" class="text-xs text-gray-500 italic pb-2">
Â  Â  Â  Â  âš ï¸ Delivery charge is set by <b>Pathao Courier Service</b>. We are not responsible for this fee. <b> the fee is depend on </b>Pathao Courier Service .
Â  Â  Â  </td>
Â  Â  </tr>
Â  Â  <tr><td class="text-green-600">Discount</td><td class="text-right text-green-600">-à§³${discount.toFixed(0)}</td></tr>
Â  Â  <tr class="total-row-summary"><td>Grand Total</td><td class="text-right font-bold text-orange-600">à§³${grandTotal.toFixed(0)}</td></tr>
Â  `;
}

/* --- Update totals whenever region or coupon changes --- */
regionEl.addEventListener("change", renderOrderSummary);
districtEl.addEventListener("change", renderOrderSummary);
upazilaEl.addEventListener("change", renderOrderSummary);
couponInput.addEventListener("input", () => {
Â  // reset displayed coupon message when user edits
Â  couponStatus.textContent = "";
});



/* ---------------- Payment Switching ---------------- */

// Helper to manage channel selection within Online Payment block
function handleChannelSelection(e) {
Â  Â  document.querySelectorAll('#online-payment-fields .select-btn[data-channel]').forEach(b => b.classList.remove('active'));
Â  Â  e.currentTarget.classList.add('active');
Â  Â  const ch = e.currentTarget.getAttribute('data-channel');
Â  Â  document.getElementById('payment-channel').value = ch;
Â  Â  showAlert("success", `ğŸ’³ ${ch} selected for online payment`);
}

// Main logic for switching between COD and Online Payment
document.querySelectorAll('.select-btn[data-method]').forEach(btn => {
Â  Â  btn.addEventListener('click', e => {
Â  Â  Â  Â  document.querySelectorAll('.select-btn[data-method]').forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  e.currentTarget.classList.add('active');
Â  Â  Â  Â  const method = e.currentTarget.getAttribute('data-method');
Â  Â  Â  Â  document.getElementById('payment-method').value = method;
Â  Â  Â  Â  const online = document.getElementById('online-payment-fields');
Â  Â  Â  Â  const show = method === "Online Payment";

Â  Â  Â  Â  online.classList.toggle('hidden', !show);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Set required attributes for online payment fields
Â  Â  Â  Â  document.getElementById('sender-number').required = show;
Â  Â  Â  Â  document.getElementById('transaction-id').required = show;

Â  Â  Â  Â  if (!show) {
Â  Â  Â  Â  Â  Â  // If switching to COD, clear online specific values
Â  Â  Â  Â  Â  Â  document.getElementById('payment-channel').value = '';
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#online-payment-fields .select-btn[data-channel]').forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  }
Â  Â  });
});

// Event listeners for Bkash / Nagad buttons
document.querySelectorAll('#online-payment-fields .select-btn[data-channel]').forEach(btn => {
Â  Â  btn.addEventListener('click', handleChannelSelection);
});



/* ---------------- Place Order ---------------- */
document.getElementById("order-form").addEventListener("submit", async ev => {
Â  ev.preventDefault();

Â  // 1. Pre-checks and Setup
Â  if (!cartItems.length) return showAlert("error", "Your cart is empty!");

Â  const orderId = "WF" + Date.now();
Â  const { grandTotal } = calculateTotals();
Â Â 
Â  // Gather form data
Â  const name = document.getElementById("name").value;
Â  const phone = document.getElementById("phone").value;
Â  const address = document.getElementById("address").value;
Â  const paymentMethod = document.getElementById("payment-method").value;
Â  const isOnline = paymentMethod === "Online Payment";
Â Â 
Â  // Online payment validation: Check if required online fields are filled
Â  if (isOnline && (!document.getElementById("payment-channel").value || !document.getElementById("sender-number").value || !document.getElementById("transaction-id").value)) {
Â  Â  return showAlert("error", "Please complete all required Online Payment fields.");
Â  }
Â Â 
Â  const order = {
Â  Â  orderId,
Â  Â  name,
Â  Â  phone,
Â  Â  region: regionEl.value,
Â  Â  district: districtEl.value,
Â  Â  upazila: upazilaEl.value,
Â  Â  address,
Â  Â  paymentMethod,
Â  Â  // Only include online-specific fields if Online Payment is selected
Â  Â  paymentChannel: isOnline ? document.getElementById("payment-channel").value : null,
Â  Â  senderNumber: isOnline ? document.getElementById("sender-number").value : null,
Â  Â  transactionId: isOnline ? document.getElementById("transaction-id").value : null,
Â  Â  cartItems,
Â  Â  grandTotal: grandTotal,
Â  Â  discount: currentDiscount,
Â  Â  timestamp: new Date().toISOString(),
Â  };

Â  placeOrderBtn.disabled = true;
Â  placeOrderBtn.textContent = "Processing...";

Â  // 2. Send to Google Sheet (Fire & Forget, in case of failure)
Â  const scriptURL = "https://script.google.com/macros/s/AKfycby7NeSZ7siDOzIsDeVwffxEEyiCAMHMI0kJENCp1218aD9KnUxGWL7XjQ1Y80RbgIkApA/exec";
Â  try {
Â  Â  await fetch(scriptURL, { method: "POST", body: JSON.stringify(order), headers: { "Content-Type": "application/json" } });
Â  } catch (e) {
Â  Â  console.error("Sheet send failed", e);
Â  }

Â  // 3. Save to Firestore & Track Coupon
Â  try {
Â  Â  // Save the main order document
Â  Â  await setDoc(doc(db, "artifacts/WideFind/public/data/Orders", orderId), order);
Â  Â Â 
Â  Â // Correct Coupon Usage Tracking Logic (FIXED FOR CASE-INSENSITIVITY)
Â  Â  if (appliedCoupon && appliedCoupon.code) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const couponRef = doc(db, "artifacts/WideFind/public/data/config/coupons");
Â  Â  Â  Â  Â  Â  const snap = await getDoc(couponRef);
Â  Â  Â  Â  Â  Â  if (snap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  const data = snap.data();
Â  Â  Â  Â  Â  Â  Â  Â  const couponCodeUpper = appliedCoupon.code.toUpperCase(); // Get the applied code in uppercase
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const updatedCodes = (data.validCodes || []).map(c => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const totalLimit = Number(c.usageLimit) || 0; // Ensure limit is a number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const usedCount = Number(c.used) || 0; // Ensure used count is a number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Check against the uppercase version of the database code
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (c.code.toUpperCase() === couponCodeUpper && totalLimit > 0 && totalLimit > usedCount) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { ...c, used: usedCount + 1 };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return c;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(couponRef, { ...data, validCodes: updatedCodes });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.error("âŒ Failed to track coupon usage:", err);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // 4. Final Cleanup and Redirect (Only runs if Firestore save succeeds)
Â  Â  localStorage.removeItem(CART_STORAGE_KEY);
Â  Â  showAlert("success", `âœ… Order placed successfully! ID: ${orderId}`);
Â  Â  setTimeout(() => window.location.href = SUCCESS_REDIRECT_URL, 2000);
Â Â 
Â  } catch (err) {
Â  Â  console.error(err);
Â  Â  showAlert("error", "âŒ Failed to save order! Please check your internet connection.");
Â  } finally {
Â  Â  placeOrderBtn.disabled = false;
Â  Â  placeOrderBtn.textContent = "Place Order";
Â  }
});

/* ---------------- Cancel Order ---------------- */
cancelOrderBtn.addEventListener("click",()=>{
Â  if(confirm("Are you sure you want to cancel this order?")){
Â  Â  showAlert("error","âŒ Order cancelled â€” returning to cart...");
Â  Â  setTimeout(()=>window.location.href="cart.html",1500);
Â  }
});
</script>


</body>
</html>




