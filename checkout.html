<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Checkout & Payment</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background:#f7f7f7; }
        .container { max-width:700px; margin:20px auto; }
        .section-header { border-bottom:3px solid #ff6600; padding-bottom:6px; margin-top:30px; margin-bottom:15px; font-weight:700; color:#333;}
        .form-card { background:#fff; border-radius:12px; padding:25px; box-shadow:0 8px 20px rgba(0,0,0,.08); margin-bottom:20px;}
        input[type="text"], input[type="tel"], textarea, select { border:1px solid #ddd; border-radius:8px; padding:10px 12px; width:100%; }
        input:focus, textarea:focus, select:focus { border-color:#ff6600; box-shadow:0 0 0 2px rgba(255,102,0,0.15); outline:none; }
        .coupon-btn { background:#008000; }
        .select-btn { padding:12px; border:2px solid #ddd; border-radius:8px; cursor:pointer; background:#f0f0f0; font-weight:600;}
        .select-btn.active { border-color:#ff6600; background:#fff0e0; color:#ff6600; transform:scale(1.02); }
        .order-summary-table { width:100%; border-collapse:collapse; font-size:0.95rem;}
        .order-summary-table th, .order-summary-table td { padding:10px 0; border-bottom:1px solid #eee; }
        .total-row-summary td { font-weight:700; color:#ff6600; border-top:2px solid #ff6600; padding-top:15px !important;}
    </style>
</head>
<body>
    <header class="bg-white shadow-md">
        <div class="container flex justify-between items-center py-4 px-4">
            <h1 class="text-2xl font-bold text-orange-600">WideFind Checkout</h1>
            <a href="cart.html" class="text-gray-600 hover:text-orange-600 font-semibold">← Back to Cart</a>
        </div>
    </header>

    <div class="container">
        <form id="order-form" class="form-card">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Complete Your Order</h2>
            <h3 class="section-header">Delivery & Contact Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium">Full Name</label><input id="name" type="text" required placeholder="Full name">
                </div>
                <div>
                    <label class="block text-sm font-medium">Phone Number</label><input id="phone" type="tel" required pattern="[0-9]{11}" placeholder="01XXXXXXXXX">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium">Region</label>
                    <select id="region" required><option value="">Select Region</option></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">District</label>
                    <select id="district" required disabled><option value="">Select District</option></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">Upazila</label>
                    <select id="upazila" required disabled><option value="">Select Upazila</option></select>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium">Full Delivery Address</label>
                <textarea id="address" rows="2" required placeholder="Apartment, suite, unit..."></textarea>
            </div>

            <h3 class="section-header">Coupon Code</h3>
            <div class="flex gap-3 mb-6">
                <div class="flex-grow">
                    <label class="block text-sm font-medium">Enter Code</label>
                    <input id="coupon-code" type="text" placeholder="Enter coupon code">
                    <p id="coupon-status" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <button type="button" id="apply-coupon-btn" class="coupon-btn text-white px-5 py-3 rounded-lg">Apply</button>
            </div>

            <h3 class="section-header">Order & Price Summary</h3>
            <div class="mb-6">
                <table class="order-summary-table">
                    <thead><tr><th class="w-2/3">Item / Description</th><th class="w-1/3 text-right">Amount (৳)</th></tr></thead>
                    <tbody id="cart-summary-body"><tr><td colspan="2" class="text-center text-gray-500 italic p-4">Cart is loading or empty...</td></tr></tbody>
                    <tfoot id="price-summary-foot"></tfoot>
                </table>
            </div>

            <h3 class="section-header">Payment Method</h3>
            <div class="flex gap-3 mb-6">
                <button type="button" class="select-btn flex-1 active" data-method="Cash on Delivery">Cash on Delivery (COD)</button>
                <button type="button" class="select-btn flex-1" data-method="Online Payment">Bkash / Nagad </button>
            </div>
            <input type="hidden" id="payment-method" value="Cash on Delivery">

            <div id="online-payment-fields" class="border-2 border-dashed border-orange-300 bg-red-50 p-4 rounded-lg hidden">
                <p class="text-lg font-bold text-red-600 mb-3">Complete Mobile Payment</p>
                <div class="p-3 bg-red-100 rounded-lg mb-4 text-center">
                    <span class="text-xl font-extrabold text-orange-600">01729789847</span> <span class="text-gray-600 font-semibold">(Bkash/Nagad Merchant)</span>
                </div>
                <div class="flex gap-3 mb-4">
                    <button type="button" class="select-btn flex-1 bg-pink-100 border-pink-500 text-pink-600" data-channel="Bkash">Bkash</button>
                    <button type="button" class="select-btn flex-1 bg-purple-100 border-purple-500 text-purple-600" data-channel="Nagad">Nagad</button>
                </div>
                <input type="hidden" id="payment-channel" value="">
                <label class="block text-sm font-medium mt-3">Your Mobile Number (Sender)</label><input id="sender-number" type="text" placeholder="01XXXXXXXXX">
                <label class="block text-sm font-medium mt-3">Transaction ID</label><input id="transaction-id" type="text" placeholder="ABC123XYZ">
            </div>

            <div class="flex gap-4 mt-8">
                <button type="submit" id="place-order-btn" class="flex-1 bg-orange-600 text-white p-4 rounded-xl font-bold">Place Order</button>
                <button type="button" id="cancel-order-btn" class="flex-1 bg-red-600 text-white p-4 rounded-xl font-bold">Cancel Order</button>
            </div>
        </form>
    </div>

    <!-- Firebase + logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Use same config as admin (replace if needed)
        const firebaseConfig = {
            apiKey: "AIzaSyDFsnU6n1-ag1XB8QgJcj5rqjWHxaJ71v8",
            authDomain: "my-ecom-site-168ab.firebaseapp.com",
            projectId: "my-ecom-site-168ab",
            storageBucket: "my-ecom-site-168ab.firebasestorage.app",
            messagingSenderId: "995581566071",
            appId: "1:995581566071:web:1640d0236302d369aefa72",
            measurementId: "G-NLHKNBHCFN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Existing site constants (kept from your original checkout) ---
        const DELIVERY_FEES = 80;
        const SUCCESS_REDIRECT_URL = 'index.html';
        const CART_STORAGE_KEY = 'widefindCart';

        // --- State ---
        let cartItems = [];
        let currentPaymentMethod = 'Cash on Delivery';
        let currentDiscount = 0;
        let appliedCoupon = null; // stores applied coupon object {code,type,amount,allowedProducts,usageLimit}
        let availableCoupons = []; // loaded from Firestore

        // --- Helper: get cart from localStorage ---
        function getCart() {
            try {
                const s = localStorage.getItem(CART_STORAGE_KEY);
                return s ? JSON.parse(s) : [];
            } catch (e) { console.error(e); return []; }
        }

   // --- GEO_DATA: now loaded from external file instead of inline ---
let GEO_DATA = {};

fetch("geo_data.json")
  .then(res => res.json())
  .then(data => {
    GEO_DATA = data;
    populateRegions(); // now fill the region dropdown
  })
  .catch(err => console.error("Failed to load geo data:", err));

// --- UI refs ---
const regionEl = document.getElementById('region');
const districtEl = document.getElementById('district');
const upazilaEl = document.getElementById('upazila');
const cartSummaryBody = document.getElementById('cart-summary-body');
const priceSummaryFoot = document.getElementById('price-summary-foot');
const applyCouponBtn = document.getElementById('apply-coupon-btn');
const couponInput = document.getElementById('coupon-code');
const couponStatus = document.getElementById('coupon-status');
const placeOrderBtn = document.getElementById('place-order-btn');
const cancelOrderBtn = document.getElementById('cancel-order-btn');

// --- Populate regions (simple) ---
function populateRegions() {
  regionEl.innerHTML = '<option value="" disabled selected>Select Region</option>';
  Object.keys(GEO_DATA).forEach(r => {
    const o = document.createElement('option');
    o.value = r;
    o.textContent = r;
    regionEl.appendChild(o);
  });
}
function populateDistricts() {
  districtEl.innerHTML = '<option value="" disabled selected>Select District</option>';
  upazilaEl.innerHTML = '<option value="" disabled selected>Select Upazila</option>';
  upazilaEl.disabled = true;
  const sel = regionEl.value;
  if (!sel) { districtEl.disabled = true; return; }
  districtEl.disabled = false;
  Object.keys(GEO_DATA[sel]).forEach(d => {
    const o = document.createElement('option');
    o.value = d;
    o.textContent = d;
    districtEl.appendChild(o);
  });
}
function populateUpazilas() {
  upazilaEl.innerHTML = '<option value="" disabled selected>Select Upazila</option>';
  const selR = regionEl.value;
  const selD = districtEl.value;
  if (!selR || !selD) { upazilaEl.disabled = true; return; }
  upazilaEl.disabled = false;
  GEO_DATA[selR][selD].forEach(u => {
    const o = document.createElement('option');
    o.value = u;
    o.textContent = u;
    upazilaEl.appendChild(o);
  });
}


        // --- Totals & rendering ---
        function calculateTotals() {
            const productTotal = cartItems.reduce((s,i) => s + ((parseFloat(i.price)||0) * (parseInt(i.qty)||0)), 0);
            const deliveryFee = DELIVERY_FEES;
            // Limit discount (if you want max cap, you can enforce here). No stacking: currentDiscount already computed
            const discount = Math.max(0, currentDiscount || 0);
            const grandTotal = Math.max(0, productTotal + deliveryFee - discount);
            return { productTotal, deliveryFee, discount, grandTotal };
        }
        function renderOrderSummary() {
            if (!cartItems.length) {
                cartSummaryBody.innerHTML = '<tr><td colspan="2" class="text-center text-red-500 italic p-4">Your cart is empty.</td></tr>';
                priceSummaryFoot.innerHTML = '';
                return;
            }
            cartSummaryBody.innerHTML = cartItems.map(i => {
                const line = (parseFloat(i.price)||0) * (parseInt(i.qty)||0);
                const details = i.name + (i.size ? ` (Size: ${i.size})` : '');
                return `<tr><td>${details} <span class="text-gray-500 text-xs">x${i.qty}</span></td><td class="text-right">৳${line.toFixed(0)}</td></tr>`;
            }).join('');
            const totals = calculateTotals();
            priceSummaryFoot.innerHTML = `
                <tr><td class="text-gray-600 pt-3">Product Total</td><td class="text-right text-gray-600 pt-3">৳${totals.productTotal.toFixed(0)}</td></tr>
                <tr><td class="text-gray-600">Delivery Fee</td><td class="text-right text-gray-600">৳${totals.deliveryFee.toFixed(0)}</td></tr>
                <tr><td class="text-green-600">Discount (Coupon)</td><td class="text-right text-green-600">- ৳${totals.discount.toFixed(0)}</td></tr>
                <tr class="total-row-summary"><td>Grand Total</td><td class="text-right">৳${totals.grandTotal.toFixed(0)}</td></tr>
            `;
        }

        // --- Coupons: load from Firestore ---
        async function loadCouponsFromFirestore() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'WideFind';
                const couponsRef = doc(db, `artifacts/${appId}/public/data/config/coupons`);
                const snap = await getDoc(couponsRef);
                availableCoupons = snap.exists() ? (snap.data().validCodes || []) : [];
            } catch (err) {
                console.error('Error loading coupons:', err);
                availableCoupons = [];
            }
        }

        // --- Coupon application logic (only one coupon allowed) ---
        function findMatchingCoupon(code) {
            if (!code) return null;
            return availableCoupons.find(c => c.code && c.code.toUpperCase() === code.toUpperCase());
        }

        function couponAppliesToCart(coupon, cart) {
            if (!coupon) return false;
            if (!coupon.allowedProducts || !coupon.allowedProducts.length) return true; // applies to all
            // coupon allowedProducts contains SKUs — check if cart has any matching allowed product
            return cart.some(item => coupon.allowedProducts.includes(item.sku));
        }

        function computeDiscountForCoupon(coupon, productTotal) {
            if (!coupon) return 0;
            if (coupon.type === 'fixed') return Math.min(productTotal, coupon.amount);
            if (coupon.type === 'percent') return Math.min(productTotal, Math.round(productTotal * (coupon.amount / 100)));
            return 0;
        }

        // Apply coupon (user action)
        function applyCouponClientSide(code) {
            couponStatus.textContent = '';
            const coupon = findMatchingCoupon(code);
            if (!coupon) { currentDiscount = 0; appliedCoupon = null; couponStatus.textContent = 'Invalid or expired coupon.'; renderOrderSummary(); return; }
            // If there's already an applied coupon and it's different, block stacking
            if (appliedCoupon && appliedCoupon.code && appliedCoupon.code !== coupon.code) {
                couponStatus.textContent = 'Only one coupon can be used per order.';
                return;
            }
            // Check usage limit (0 = unlimited)
            if (typeof coupon.usageLimit === 'number' && coupon.usageLimit === 0) {
                // unlimited
            } else if (typeof coupon.usageLimit === 'number' && coupon.usageLimit <= 0) {
                couponStatus.textContent = 'This coupon has no remaining uses.';
                return;
            }

            // Check allowed products
            if (!couponAppliesToCart(coupon, cartItems)) {
                couponStatus.textContent = 'This coupon is not valid for items in your cart.';
                return;
            }

            // Passes all checks; compute discount
            const productTotal = cartItems.reduce((s,i) => s + ((parseFloat(i.price)||0)*(parseInt(i.qty)||0)), 0);
            const discount = computeDiscountForCoupon(coupon, productTotal);

            appliedCoupon = coupon;
            currentDiscount = discount;
            couponStatus.textContent = `Coupon ${coupon.code} applied — you saved ৳${discount.toFixed(0)}.`;
            renderOrderSummary();
        }

        // Decrement coupon usage (write to Firestore) — call after successful order
        async function decrementCouponUsageInFirestore(code) {
            if (!code) return;
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'WideFind';
                const couponsRef = doc(db, `artifacts/${appId}/public/data/config/coupons`);
                const snap = await getDoc(couponsRef);
                if (!snap.exists()) return;
                const list = snap.data().validCodes || [];
                const newList = list.map(c => {
                    if (c.code && c.code.toUpperCase() === code.toUpperCase()) {
                        // if unlimited (0) keep 0, else decrement but never below 0
                        const ul = typeof c.usageLimit === 'number' ? c.usageLimit : 0;
                        return { ...c, usageLimit: ul > 0 ? ul - 1 : 0 };
                    }
                    return c;
                });
                await setDoc(couponsRef, { validCodes: newList });
            } catch (err) {
                console.error('Error decrementing coupon usage:', err);
            }
        }

        // --- Attach UI listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            // prepare cart
            if (!localStorage.getItem(CART_STORAGE_KEY)) {
                const dummy = [
                    { sku: 'TSHIRT-001', name: 'Classic T-Shirt', price: 1200, qty: 1, size: 'L' },
                    { sku: 'WATCH-001', name: 'Smart Watch', price: 4999, qty: 1, size: '' }
                ];
                localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(dummy));
            }
            cartItems = getCart();

            populateRegions();
            renderOrderSummary();
            await loadCouponsFromFirestore(); // load coupons early

            // geo listeners
            regionEl.addEventListener('change', populateDistricts);
            districtEl.addEventListener('change', populateUpazilas);

            // payment method buttons
            document.querySelectorAll('.select-btn[data-method]').forEach(btn => {
                btn.addEventListener('click', e => {
                    document.querySelectorAll('.select-btn[data-method]').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    currentPaymentMethod = e.currentTarget.getAttribute('data-method');
                    document.getElementById('payment-method').value = currentPaymentMethod;
                    document.getElementById('online-payment-fields').classList.toggle('hidden', currentPaymentMethod !== 'Online Payment');
                    document.getElementById('sender-number').required = (currentPaymentMethod === 'Online Payment');
                    document.getElementById('transaction-id').required = (currentPaymentMethod === 'Online Payment');
                });
            });

            // online channel buttons
            document.querySelectorAll('#online-payment-fields .select-btn[data-channel]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('#online-payment-fields .select-btn[data-channel]').forEach(b=>b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    document.getElementById('payment-channel').value = e.currentTarget.getAttribute('data-channel');
                });
            });

            // coupon apply button
            applyCouponBtn.addEventListener('click', async () => {
                // reload coupons before applying to get latest usage limit info
                await loadCouponsFromFirestore();
                const code = couponInput.value.trim();
                applyCouponClientSide(code);
            });

            // place order handler
            document.getElementById('order-form').addEventListener('submit', async (ev) => {
                ev.preventDefault();
                if (!cartItems.length) { alert('Your cart is empty.'); return; }
                if (!regionEl.value || !districtEl.value || !upazilaEl.value) { alert('Please select region/district/upazila.'); return; }

                // check for items that require online payment
                const PRODUCT_DB = {
                    'TSHIRT-001': { name: "Classic T-Shirt", price: 1200, isOnlinePaymentRequired: false },
                    'SUNGLASS-001': { name: "Aviator Sunglass", price: 999, isOnlinePaymentRequired: false },
                    'WATCH-001': { name: "Smart Watch", price: 4999, isOnlinePaymentRequired: false },
                    'EARBUD-002': { name: "Wireless Earbuds", price: 3500, isOnlinePaymentRequired: false },
                    'MUG-003': { name: "Ceramic Mug", price: 450, isOnlinePaymentRequired: false },
                };
                const onlineRequired = cartItems.some(item => PRODUCT_DB[item.sku]?.isOnlinePaymentRequired);
                if (onlineRequired && currentPaymentMethod !== 'Online Payment') {
                    alert('A required item must be paid online. Please choose Online Payment.');
                    return;
                }

                // Re-validate coupon usage-limit right before placing order
                if (appliedCoupon) {
                    await loadCouponsFromFirestore();
                    const fresh = findMatchingCoupon(appliedCoupon.code);
                    if (!fresh) { alert('Applied coupon no longer valid.'); appliedCoupon = null; currentDiscount = 0; renderOrderSummary(); return; }
                    if (!(typeof fresh.usageLimit === 'number' && fresh.usageLimit === 0) && fresh.usageLimit <= 0) {
                        alert('Applied coupon has no remaining uses.'); appliedCoupon = null; currentDiscount = 0; renderOrderSummary(); return;
                    }
                    // ensure it still applies to cart
                    if (!couponAppliesToCart(fresh, cartItems)) {
                        alert('Applied coupon is not applicable to items in your cart.'); appliedCoupon=null; currentDiscount=0; renderOrderSummary(); return;
                    }
                    // recompute discount from freshest coupon data
                    const productTotal = cartItems.reduce((s,i)=>s+((parseFloat(i.price)||0)*(parseInt(i.qty)||0)),0);
                    currentDiscount = computeDiscountForCoupon(fresh, productTotal);
                    appliedCoupon = fresh;
                    renderOrderSummary();
                }

                // process "order" (simulated here)
                placeOrderBtn.disabled = true;
                placeOrderBtn.textContent = 'Processing...';
                try {
                    // simulate order creation: in real app you would send order data to server / Firestore orders collection
                    const orderId = 'WF' + Date.now();
                    
                    
                      // --- also send order to Google Sheets ---
  const scriptURL = "https://script.google.com/macros/s/AKfycby7NeSZ7siDOzIsDeVwffxEEyiCAMHMI0kJENCp1218aD9KnUxGWL7XjQ1Y80RbgIkApA/exec"; // <-- replace with your real deployment URL
  const order = {
    orderId: orderId,
    name: document.getElementById('name').value,
    phone: document.getElementById('phone').value,
    region: regionEl.value,
    district: districtEl.value,
    upazila: upazilaEl.value,
    address: document.getElementById('address').value,
    paymentMethod: document.querySelector('input[name="payment"]:checked')?.value || '',
    transactionId: document.getElementById('txn-id')?.value || '',
    cartItems: JSON.stringify(cartItems),
  };
  
  
  // ✅ Send order to Google Sheets
try {
  await fetch(scriptURL, {
    method: "POST",
    body: JSON.stringify(order),
    headers: { "Content-Type": "application/json" }
  });
  console.log("✅ Order sent to Google Sheets");
} catch (err) {
  console.error("❌ Failed to send to Google Sheets", err);
}

                    
                    // If coupon applied and has usageLimit > 0, decrement in Firestore
                    if (appliedCoupon && typeof appliedCoupon.usageLimit === 'number' && appliedCoupon.usageLimit > 0) {
                        await decrementCouponUsageInFirestore(appliedCoupon.code);
                    }
                    // Clear cart
                    localStorage.removeItem(CART_STORAGE_KEY);
                    alert(`Order Placed Successfully! Order ID: ${orderId}`);
                    window.location.href = SUCCESS_REDIRECT_URL;
                } catch (err) {
                    console.error(err);
                    alert('Error placing order: ' + (err.message || err));
                } finally {
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.textContent = 'Place Order';
                }
            });

            document.getElementById('cancel-order-btn').addEventListener('click', () => {
                if (confirm('Cancel and go back to cart?')) window.location.href = 'cart.html';
            });

            renderOrderSummary();
        });
        
        
        // Add button click animation (safe to put at bottom)
const applyBtn = document.getElementById("apply-coupon-btn");

if (applyBtn) {
  applyBtn.addEventListener("click", () => {
    // Add loading animation for visual feedback
    applyBtn.classList.add("loading");

    // Remove animation after 1.5 seconds
    setTimeout(() => applyBtn.classList.remove("loading"), 1500);

    // If your page already has a function named applyCoupon(),
    // call it here to run your existing coupon logic.
    if (typeof applyCoupon === "function") {
      applyCoupon();
    }
  });
}

    </script>
</body>
</html>
