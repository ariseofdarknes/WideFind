<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Product Details</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .cart-badge {
            position: relative;
            display: inline-block;
            font-size: 1.5rem;
            cursor: pointer;
            color: #ff6600;
            text-decoration: none;
        }
        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6600;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }
        .qty-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #ff6600;
            background: white;
            color: #ff6600;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .qty-btn:hover {
            background: #ff6600;
            color: white;
        }
        .qty-display {
            font-size: 1.3rem;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<header class="site-header">
    <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
        <a href="index.html" class="logo" style="text-decoration: none; color: #ff6600; font-size: 1.5rem; font-weight: bold;">WideFind</a>
        <a href="cart.html" class="cart-badge" title="View Cart">
            ðŸ›’
            <span class="cart-count" id="cart-count">0</span>
        </a>
    </div>
</header>

<main class="product-page container">

    <div class="product-gallery">
        <div class="main-image-container">
            <img id="product-image" src="https://placehold.co/600x600?text=Loading..." alt="Product Image">
        </div>
        <div id="thumbnail-list" class="thumbnail-list"></div>
    </div>

    <div class="product-details">
        <h2 id="product-name">Loading...</h2>

        <div class="product-price-ref">
            <span class="sale-price" id="product-price">à§³0</span>
            <span class="original-price" id="product-original" style="display:none;">à§³0</span>
            <span class="discount-percent" id="product-discount" style="display:none;">-0%</span>
        </div>

        <p id="product-description"></p>

        <h4 id="size-label">Available Sizes</h4>
        <div id="size-options" class="size-container"></div>

        <div class="quantity-controls">
            <label style="font-weight: 600;">Quantity:</label>
            <button class="qty-btn" id="qty-minus">âˆ’</button>
            <div class="qty-display" id="qty-display">1</div>
            <button class="qty-btn" id="qty-plus">+</button>
        </div>

        <button id="add-to-cart" class="btn-buy">Add to Cart</button>
    </div>




<!-- ================= Related Random Products ================== -->
<div style="max-width:1200px;margin:40px auto;">
  <h2 style="font-size:22px;margin-bottom:15px;">You May Also Like</h2>
  <div id="randomProducts" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;"></div>
</div>



</main>

<footer class="site-footer" style="text-align: center; padding: 20px; background: #fff; margin-top: 40px;">
    <p>Â© 2025 WideFind. All Rights Reserved.</p>
</footer>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

function getValidImageURL(url) {
    if (!url) return "https://placehold.co/600x600?text=No+Image";
    if (url.includes("imgur.com") && !url.includes("i.imgur.com")) {
        const match = url.match(/imgur\.com\/(?:a\/|gallery\/)?([A-Za-z0-9]+)/);
        if (match && match[1]) return `https://i.imgur.com/${match[1]}.jpg`;
    }
    return url;
}

const firebaseConfig = {
    apiKey: "AIzaSyDFsnU6n1-ag1XB8QgJcj5rqjWHxaJ71v8",
    authDomain: "my-ecom-site-168ab.firebaseapp.com",
    projectId: "my-ecom-site-168ab",
    storageBucket: "my-ecom-site-168ab.appspot.com",
    messagingSenderId: "995581566071",
    appId: "1:995581566071:web:1640d0236302d369aefa72",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const appId = "WideFind";
const CART_STORAGE_KEY = 'widefindCart';

let currentQty = 1;

function getCart() {
    try { return JSON.parse(localStorage.getItem(CART_STORAGE_KEY) || "[]"); }
    catch(e){ console.error(e); return []; }
}

function saveCart(cart){ 
    localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart)); 
    updateCartCount();
}

function updateCartCount() {
    try {
        const cart = getCart();
        const totalItems = cart.reduce((sum, item) => sum + (Number(item.qty) || 0), 0);
        document.getElementById('cart-count').textContent = totalItems;
    } catch (e) {
        console.error('Error updating cart count:', e);
    }
}

function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
}

const productId = getQueryParam('id') || getQueryParam('sku');
if (!productId) {
    document.getElementById('product-name').innerText = 'Product not specified';
} else {
    loadProduct(productId);
}

async function loadProduct(productId) {
    try {
        const ref = doc(db, `artifacts/${appId}/public/data/products/${productId}`);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
            document.getElementById('product-name').innerText = 'Product not found';
            return;
        }
        const p = snap.data();

        if (typeof p.images === "string") {
            p.images = p.images.split(',').map(i => i.trim()).filter(i => i);
        }

        // Image gallery
        const mainImg = document.getElementById("product-image");
        const thumbList = document.getElementById("thumbnail-list");
        thumbList.innerHTML = '';

        if (p.images && p.images.length > 0) {
            mainImg.src = getValidImageURL(p.images[0]);
            p.images.forEach((url, index) => {
                const thumb = document.createElement('img');
                thumb.src = getValidImageURL(url);
                if (index === 0) thumb.classList.add('active');
                thumb.addEventListener('click', () => {
                    document.querySelectorAll('.thumbnail-list img').forEach(img => img.classList.remove('active'));
                    thumb.classList.add('active');
                    mainImg.src = getValidImageURL(url);
                });
                thumbList.appendChild(thumb);
            });
        } else {
            mainImg.src = 'https://placehold.co/600x600?text=No+Image';
        }

        document.getElementById("product-name").innerText = p.name || '';
        document.getElementById("product-description").innerText = p.description || '';
        document.getElementById("product-price").innerText = `à§³${Number(p.price || 0).toFixed(0)}`;

        if (p.originalPrice) {
            document.getElementById("product-original").style.display = 'inline-block';
            document.getElementById("product-original").innerText = `à§³${Number(p.originalPrice).toFixed(0)}`;
        } else {
            document.getElementById("product-original").style.display = 'none';
        }

        // Discount display
        let displayPercent = 0;
        if (p.discountPercent && Number(p.discountPercent) > 0) displayPercent = Math.round(Number(p.discountPercent));
        else if (p.discountAmount && p.originalPrice && Number(p.originalPrice) > 0)
            displayPercent = Math.round((Number(p.discountAmount) / Number(p.originalPrice)) * 100);

        if (displayPercent > 0) {
            const dEl = document.getElementById('product-discount');
            dEl.style.display = 'inline-block';
            dEl.innerText = `-${displayPercent}%`;
        } else {
            document.getElementById('product-discount').style.display = 'none';
        }

        // Size options
        const sizes = p.sizes || [];
        const sizeOptions = document.getElementById('size-options');
        sizeOptions.innerHTML = '';
        if (sizes.length) {
            const select = document.createElement('select');
            select.id = 'size-select';
            sizes.forEach(s => {
                const o = document.createElement('option'); 
                o.value = s; 
                o.textContent = s;
                select.appendChild(o);
            });
            sizeOptions.appendChild(select);
        } else {
            sizeOptions.innerHTML = '<small class="text-gray-500">No size selection</small>';
        }

        // Quantity controls
        document.getElementById('qty-minus').addEventListener('click', () => {
            if (currentQty > 1) {
                currentQty--;
                document.getElementById('qty-display').textContent = currentQty;
            }
        });

        document.getElementById('qty-plus').addEventListener('click', () => {
            currentQty++;
            document.getElementById('qty-display').textContent = currentQty;
        });

        // Add to cart
        document.getElementById('add-to-cart').addEventListener('click', () => {
            const sizeVal = document.getElementById('size-select') ? document.getElementById('size-select').value : '';
            addToCart({
                sku: p.sku || productId,
                itemId: String(Date.now()) + '-' + Math.floor(Math.random()*9999),
                name: p.name || '',
                price: Number(p.price || 0),
                qty: currentQty,
                size: sizeVal,
                image: (p.images && p.images[0]) ? p.images[0] : ''
            });
            
            // Show success message
            const btn = document.getElementById('add-to-cart');
            const originalText = btn.textContent;
            btn.textContent = 'âœ“ Added to Cart!';
            btn.style.background = '#28a745';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#ff6600';
            }, 2000);
        });

    } catch (err) {
        console.error(err);
        document.getElementById('product-name').innerText = 'Failed to load product';
    }
}

function addToCart(item) {
    const cart = getCart();
    const existing = cart.find(ci => ci.sku === item.sku && (ci.size || '') === (item.size || ''));
    if (existing) {
        existing.qty = (existing.qty || 0) + item.qty;
    } else {
        cart.push(item);
    }
    saveCart(cart);
}

document.addEventListener('DOMContentLoaded', () => {
    updateCartCount();
});
</script>

<script>
  async function loadRandomProducts() {
    try {
      const res = await fetch("data/products.json");
      const products = await res.json();

      // Shuffle
      const shuffled = products.sort(() => 0.5 - Math.random());
      
      // Pick 4 random items
      const selected = shuffled.slice(0, 4);

      const container = document.getElementById("randomProducts");

      selected.forEach(p => {
        const item = document.createElement("a");
        item.href = `product.html?id=${p.id}`;
        item.style = `
          border:1px solid #ddd; border-radius:8px;padding:10px;
          background:#fff;text-align:center;text-decoration:none;color:#000;
          display:block;box-shadow:0 2px 6px rgba(0,0,0,0.1);transition:.3s;
        `;
        item.innerHTML = `
          <img src="${p.image}" alt="${p.name}" style="width:100%;height:130px;object-fit:cover;border-radius:6px;" />
          <h4 style="font-size:15px;margin:8px 0;">${p.name}</h4>
          <p style="color:#ff3c00;font-weight:600;">à§³${p.price}</p>
        `;
        item.onmouseover = () => item.style.transform = "scale(1.03)";
        item.onmouseout = () => item.style.transform = "scale(1)";

        container.appendChild(item);
      });
    } catch (err) {
      console.error("Error loading random products", err);
    }
  }

  loadRandomProducts();
</script>


</body>
</html>
