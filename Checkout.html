<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Checkout & Payment</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background:#f7f7f7; }
        .container { max-width:700px; margin:20px auto; }
        .section-header { border-bottom:3px solid #ff6600; padding-bottom:6px; margin-top:30px; margin-bottom:15px; font-weight:700; color:#333;}
        .form-card { background:#fff; border-radius:12px; padding:25px; box-shadow:0 8px 20px rgba(0,0,0,.08); margin-bottom:20px;}
        input[type="text"], input[type="tel"], textarea, select { border:1px solid #ddd; border-radius:8px; padding:10px 12px; width:100%; }
        input:focus, textarea:focus, select:focus { border-color:#ff6600; box-shadow:0 0 0 2px rgba(255,102,0,0.15); outline:none; }
        .coupon-btn { background:#008000; }
        .select-btn { padding:12px; border:2px solid #ddd; border-radius:8px; cursor:pointer; background:#f0f0f0; font-weight:600;}
        .select-btn.active { border-color:#ff6600; background:#fff0e0; color:#ff6600; transform:scale(1.02); }
        .order-summary-table { width:100%; border-collapse:collapse; font-size:0.95rem;}
        .order-summary-table th, .order-summary-table td { padding:10px 0; border-bottom:1px solid #eee; }
        .total-row-summary td { font-weight:700; color:#ff6600; border-top:2px solid #ff6600; padding-top:15px !important;}
    </style>
</head>
<body>
    <header class="bg-white shadow-md">
        <div class="container flex justify-between items-center py-4 px-4">
            <h1><a href="index.html" class="logo-gold">WideFind Checkout</a></h1>
            <a href="cart.html" class="text-gray-600 hover:text-orange-600 font-semibold">‚Üê Back to Cart</a>
        </div>
    </header>

    <div class="container">
        <form id="order-form" class="form-card">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Complete Your Order</h2>
            <h3 class="section-header">Delivery & Contact Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium">Full Name</label><input id="name" type="text" required placeholder="Full name">
                </div>
                <div>
                    <label class="block text-sm font-medium">Phone Number</label><input id="phone" type="tel" required pattern="[0-9]{11}" placeholder="01XXXXXXXXX">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium">Region</label>
                    <select id="region" required><option value="">Select Region</option></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">District</label>
                    <select id="district" required disabled><option value="">Select District</option></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">Upazila</label>
                    <select id="upazila" required disabled><option value="">Select Upazila</option></select>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium">Full Delivery Address</label>
                <textarea id="address" rows="2" required placeholder="Apartment, suite, unit..."></textarea>
            </div>

            <h3 class="section-header">Coupon Code</h3>
            <div class="flex gap-3 mb-6">
                <div class="flex-grow">
                    <label class="block text-sm font-medium">Enter Code</label>
                    <input id="coupon-code" type="text" placeholder="Enter coupon code">
                    <p id="coupon-status" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <button type="button" id="apply-coupon-btn" class="coupon-btn text-white px-5 py-3 rounded-lg">Apply</button>
            </div>

            <h3 class="section-header">Order & Price Summary</h3>
            <div class="mb-6">
                <table class="order-summary-table">
                    <thead><tr><th class="w-2/3">Item / Description</th><th class="w-1/3 text-right">Amount (‡ß≥)</th></tr></thead>
                    <tbody id="cart-summary-body"><tr><td colspan="2" class="text-center text-gray-500 italic p-4">Cart is loading or empty...</td></tr></tbody>
                    <tfoot id="price-summary-foot"></tfoot>
                </table>
            </div>

            <h3 class="section-header">Payment Method</h3>
            <div class="flex gap-3 mb-6">
                <button type="button" class="select-btn flex-1 active" data-method="Cash on Delivery">Cash on Delivery (COD)</button>
                <button type="button" class="select-btn flex-1" data-method="Online Payment">Bkash / Nagad </button>
            </div>
            <input type="hidden" id="payment-method" value="Cash on Delivery">

            <div id="online-payment-fields" class="border-2 border-dashed border-orange-300 bg-red-50 p-4 rounded-lg hidden">
                <p class="text-lg font-bold text-red-600 mb-3">Complete Mobile Payment</p>
                <div class="p-3 bg-red-100 rounded-lg mb-4 text-center">
                    <span class="text-xl font-extrabold text-orange-600">01729789847</span> <span class="text-gray-600 font-semibold">(Bkash/Nagad Merchant)</span>
                </div>
                <div class="flex gap-3 mb-4">
                    <button type="button" class="select-btn flex-1 bg-pink-100 border-pink-500 text-pink-600" data-channel="Bkash">Bkash</button>
                    <button type="button" class="select-btn flex-1 bg-purple-100 border-purple-500 text-purple-600" data-channel="Nagad">Nagad</button>
                </div>
                <input type="hidden" id="payment-channel" value="">
                <label class="block text-sm font-medium mt-3">Your Mobile Number (Sender)</label><input id="sender-number" type="text" placeholder="01XXXXXXXXX">
                <label class="block text-sm font-medium mt-3">Transaction ID</label><input id="transaction-id" type="text" placeholder="ABC123XYZ">
            </div>

            <div class="flex gap-4 mt-8">
                <button type="submit" id="place-order-btn" class="flex-1 bg-orange-600 text-white p-4 rounded-xl font-bold">Place Order</button>
                <button type="button" id="cancel-order-btn" class="flex-1 bg-red-600 text-white p-4 rounded-xl font-bold">Cancel Order</button>
            </div>
        </form>
    </div>

    <!-- Firebase + logic -->
    
    
    
    
    
    
   <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ---------------- Firebase Setup ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDFsnU6n1-ag1XB8QgJcj5rqjWHxaJ71v8",
  authDomain: "my-ecom-site-168ab.firebaseapp.com",
  projectId: "my-ecom-site-168ab",
  storageBucket: "my-ecom-site-168ab.firebasestorage.app",
  messagingSenderId: "995581566071",
  appId: "1:995581566071:web:1640d0236302d369aefa72",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------------- Constants & Elements ---------------- */
const DELIVERY_FEES = 80;
const CART_STORAGE_KEY = "widefindCart";
const SUCCESS_REDIRECT_URL = "index.html";

const regionEl = document.getElementById("region");
const districtEl = document.getElementById("district");
const upazilaEl = document.getElementById("upazila");
const applyCouponBtn = document.getElementById("apply-coupon-btn");
const couponInput = document.getElementById("coupon-code");
const couponStatus = document.getElementById("coupon-status");
const placeOrderBtn = document.getElementById("place-order-btn");
const cancelOrderBtn = document.getElementById("cancel-order-btn");
const cartSummaryBody = document.getElementById("cart-summary-body");
const priceSummaryFoot = document.getElementById("price-summary-foot");

// --- Global Data Holders ---
let GEO_DATA = {};
let cartItems = [];
let availableCoupons = [];
let appliedCoupon = null;
let currentDiscount = 0;

/* ---------------- HQ Animated Alert ---------------- */
function showAlert(type, msg) {
  const box = document.createElement("div");
  box.className =
    "fixed top-5 right-5 z-50 flex items-center gap-3 px-5 py-3 rounded-xl text-white font-semibold shadow-xl backdrop-blur-md transition-all duration-500 transform scale-95 opacity-0";
  box.innerHTML =
    type === "success"
      ? `<svg class='w-6 h-6 text-white animate-bounce' fill='none' stroke='currentColor' stroke-width='3' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' d='M5 13l4 4L19 7'/></svg><span>${msg}</span>`
      : `<svg class='w-6 h-6 text-white animate-pulse' fill='none' stroke='currentColor' stroke-width='3' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' d='M6 18L18 6M6 6l12 12'/></svg><span>${msg}</span>`;
  box.style.background =
    type === "success"
      ? "linear-gradient(90deg,#10B981,#34D399)"
      : "linear-gradient(90deg,#EF4444,#F87171)";
  document.body.appendChild(box);
  setTimeout(() => {
    box.style.opacity = "1";
    box.style.transform = "scale(1)";
  }, 50);
  setTimeout(() => {
    box.style.opacity = "0";
    box.style.transform = "scale(0.95)";
    setTimeout(() => box.remove(), 400);
  }, 3000);
}

/* ---------------- Geo Data Loader ---------------- */
fetch("geo_data.json")
  .then(res => res.json())
  .then(data => {
    GEO_DATA = data;
    populateRegions();
  })
  .catch(err => console.error("Failed to load geo_data:", err));

function populateRegions() {
  regionEl.innerHTML = '<option value="" disabled selected>Select Region</option>';
  Object.keys(GEO_DATA).forEach(r => {
    const o = document.createElement("option");
    o.value = r;
    o.textContent = r;
    regionEl.appendChild(o);
  });
}
function populateDistricts() {
  districtEl.innerHTML = '<option value="" disabled selected>Select District</option>';
  upazilaEl.innerHTML = '<option value="" disabled selected>Select Upazila</option>';
  upazilaEl.disabled = true;
  const sel = regionEl.value;
  if (!sel) { districtEl.disabled = true; return; }
  districtEl.disabled = false;
  Object.keys(GEO_DATA[sel]).forEach(d => {
    const o = document.createElement("option");
    o.value = d; o.textContent = d;
    districtEl.appendChild(o);
  });
}
function populateUpazilas() {
  upazilaEl.innerHTML = '<option value="" disabled selected>Select Upazila</option>';
  const selR = regionEl.value;
  const selD = districtEl.value;
  if (!selR || !selD) { upazilaEl.disabled = true; return; }
  upazilaEl.disabled = false;
  GEO_DATA[selR][selD].forEach(u => {
    const o = document.createElement("option");
    o.value = u; o.textContent = u;
    upazilaEl.appendChild(o);
  });
}
regionEl.addEventListener("change", populateDistricts);
districtEl.addEventListener("change", populateUpazilas);

/* ---------------- Cart + Coupon Logic ---------------- */
function getCart() {
  try {
    return JSON.parse(localStorage.getItem(CART_STORAGE_KEY)) || [];
  } catch { return []; }
}


async function loadCouponsFromFirestore() {
  try {
    const ref = doc(db, "artifacts/WideFind/public/data/config/coupons");
    const snap = await getDoc(ref);
    availableCoupons = snap.exists() ? snap.data().validCodes || [] : [];
    console.log("‚úÖ Coupons loaded:", availableCoupons);
  } catch (err) {
    console.error("Error loading coupons:", err);
    availableCoupons = [];
  }
}

function findMatchingCoupon(code) {
  return availableCoupons.find(c => c.code && c.code.toUpperCase() === code.toUpperCase());
}
function couponAppliesToCart(coupon, cart) {
  if (!coupon) return false;
  if (!coupon.allowedProducts || !coupon.allowedProducts.length) return true;
  return cart.some(i => coupon.allowedProducts.includes(i.sku));
}
function computeDiscount(coupon, total) {
  if (!coupon) return 0;
  return coupon.type === "percent"
    ? Math.round(total * (coupon.amount / 100))
    : coupon.amount;
}



function applyCouponClientSide(code) {
  couponStatus.textContent = "";
  const coupon = findMatchingCoupon(code);
  
  // 1. Check if coupon exists and is ACTIVE
  if (!coupon || coupon.status !== "active") {
    currentDiscount = 0;
    appliedCoupon = null;
    showAlert("error", "‚ùå Coupon is invalid or deactivated.");
    couponStatus.innerHTML = `<span class="text-red-500 font-bold">Coupon not available.</span>`;
    return;
  }

  // 2. CHECK USAGE LIMIT
  const usageLimit = coupon.usageLimit || 999999;
  const timesUsed = coupon.used || 0;

  if (timesUsed >= usageLimit) {
    currentDiscount = 0;
    appliedCoupon = null;
    showAlert("error", "üö´ This coupon has reached its usage limit.");
    couponStatus.innerHTML = `<span class="text-red-500 font-bold">Coupon Expired.</span>`;
    return;
  }

  // 3. CHECK MINIMUM PURCHASE (Dynamic)
  const productTotal = cartItems.reduce((s, i) => s + (Number(i.price) * Number(i.qty)), 0);
  const minRequired = coupon.minPurchase || 0; 

  if (productTotal < minRequired) {
    currentDiscount = 0;
    appliedCoupon = null;
    showAlert("error", `Minimum ‡ß≥${minRequired} required.`);
    couponStatus.innerHTML = `<span class="text-red-500 font-bold">Add ‡ß≥${minRequired - productTotal} more to unlock.</span>`;
    return;
  }

  // 4. Success - Hold the coupon in memory (Do not update database yet!)
  currentDiscount = computeDiscount(coupon, productTotal);
  appliedCoupon = coupon;
  
  couponStatus.innerHTML = `<span class="text-green-600 font-bold">‚úÖ Coupon Applied! Saved ‡ß≥${currentDiscount}</span>`;
  showAlert("success", "Coupon Applied!");
}



       
 // coupons btn)  
applyCouponBtn.addEventListener("click", async () => {
  applyCouponBtn.disabled = true;
  applyCouponBtn.innerHTML =
    `<svg class="animate-spin h-5 w-5 mr-2 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
       <circle class="opacity-25" cx="12" cy="12" r="10" stroke="white" stroke-width="4"></circle>
       <path class="opacity-75" fill="white" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
     </svg> Applying...`;

  // Refresh coupons from Firestore (in case admin changed them)
  await loadCouponsFromFirestore();

  const code = couponInput.value.trim();

  // Attempt to apply coupon; applyCouponClientSide sets currentDiscount or leaves it 0
  applyCouponClientSide(code);

  // IMPORTANT: re-render the order summary so Discount & Grand Total update immediately
  renderOrderSummary();

  // Enable button again after short delay to keep UX smooth
  setTimeout(() => {
    applyCouponBtn.disabled = false;
    applyCouponBtn.textContent = "Apply";
  }, 1000);
});




/* ---------------- Initialize checkout ---------------- */
document.addEventListener('DOMContentLoaded', async () => {
  // Load cart from localStorage
  cartItems = getCart();
  console.log("DEBUG: checkout cartItems:", cartItems);

  // If cart is empty, inform user and redirect back to cart page
  if (!cartItems.length) {
    showAlert("error", "üõí Your cart is empty ‚Äî you will be returned to Cart.");
    setTimeout(() => (window.location.href = "cart.html"), 1800);
    return;
  }

  // Ensure geo data is available before populating regions
  if (Object.keys(GEO_DATA).length) {
    populateRegions();
  } else {
    try {
      const res = await fetch("geo_data.json");
      GEO_DATA = await res.json();
      populateRegions();
    } catch (err) {
      console.error("Geo data failed:", err);
      showAlert("error", "‚ö†Ô∏è Could not load delivery regions.");
    }
  }

  // Render the order summary now that cartItems is ready
  renderOrderSummary();

  // Load coupons (background)
  await loadCouponsFromFirestore();
});





/* ---------------- Dynamic Totals & Summary ---------------- */

// base delivery fees by region (you can adjust values)
const DELIVERY_FEES_BY_REGION = {
  Dhaka: 80,
  Chattogram: 100,
  Rajshahi: 120,
  Khulna: 120,
  Sylhet: 110,
  Rangpur: 130,
  Barishal: 130,
  Mymensingh: 120,
};

// get delivery fee based on selected region
function getDeliveryFee() {
  const region = regionEl.value;
  return DELIVERY_FEES_BY_REGION[region] || 80; // default 80
}

// compute all totals
function calculateTotals() {
  const productTotal = cartItems.reduce(
    (sum, item) => sum + (Number(item.price) || 0) * (Number(item.qty) || 0),
    0
  );
  const deliveryFee = getDeliveryFee();
  const discount = currentDiscount || 0;
  const grandTotal = Math.max(productTotal + deliveryFee - discount, 0);
  return { productTotal, deliveryFee, discount, grandTotal };
}

// render summary table
function renderOrderSummary() {
  if (!cartItems.length) {
    cartSummaryBody.innerHTML =
      '<tr><td colspan="2" class="text-center text-gray-500 italic p-4">Cart is empty.</td></tr>';
    priceSummaryFoot.innerHTML = "";
    return;
  }

  cartSummaryBody.innerHTML = cartItems
    .map(
      (i) => `
      <tr>
        <td>${i.name} <span class="text-xs text-gray-500">x${i.qty}</span></td>
        <td class="text-right">‡ß≥${(i.price * i.qty).toFixed(0)}</td>
      </tr>`
    )
    .join("");

  const { productTotal, deliveryFee, discount, grandTotal } = calculateTotals();

  // ‚úÖ Includes Pathao courier service notice
  priceSummaryFoot.innerHTML = `
    <tr><td class="text-gray-600 pt-2">Product Total</td><td class="text-right text-gray-600 pt-2">‡ß≥${productTotal.toFixed(0)}</td></tr>
    <tr>
      <td class="text-gray-600">Delivery Fee</td>
      <td class="text-right text-gray-600">‡ß≥${deliveryFee.toFixed(0)}</td>
    </tr>
    <tr>
      <td colspan="2" class="text-xs text-gray-500 italic pb-2">
        ‚ö†Ô∏è Delivery charge is set by <b>Pathao Courier Service</b>. We are not responsible for this fee.
      </td>
    </tr>
    <tr><td class="text-green-600">Discount</td><td class="text-right text-green-600">-‡ß≥${discount.toFixed(0)}</td></tr>
    <tr class="total-row-summary"><td>Grand Total</td><td class="text-right font-bold text-orange-600">‡ß≥${grandTotal.toFixed(0)}</td></tr>
  `;
}

/* --- Update totals whenever region or coupon changes --- */
regionEl.addEventListener("change", renderOrderSummary);
districtEl.addEventListener("change", renderOrderSummary);
upazilaEl.addEventListener("change", renderOrderSummary);
couponInput.addEventListener("input", () => {
  // reset displayed coupon message when user edits
  couponStatus.textContent = "";
});



/* ---------------- Payment Switching ---------------- */
document.querySelectorAll('.select-btn[data-method]').forEach(btn=>{
  btn.addEventListener('click',e=>{
    document.querySelectorAll('.select-btn[data-method]').forEach(b=>b.classList.remove('active'));
    e.currentTarget.classList.add('active');
    const method=e.currentTarget.getAttribute('data-method');
    document.getElementById('payment-method').value=method;
    const online=document.getElementById('online-payment-fields');
    const show=method==="Online Payment";
    online.classList.toggle('hidden',!show);
    document.getElementById('sender-number').required=show;
    document.getElementById('transaction-id').required=show;
  });
});

document.querySelectorAll('#online-payment-fields .select-btn[data-channel]').forEach(btn=>{
  btn.addEventListener('click',e=>{
    document.querySelectorAll('#online-payment-fields .select-btn[data-channel]').forEach(b=>b.classList.remove('active'));
    e.currentTarget.classList.add('active');
    const ch=e.currentTarget.getAttribute('data-channel');
    document.getElementById('payment-channel').value=ch;
    showAlert("success",`üí≥ ${ch} selected for online payment`);
  });
});

/* ---------------- Place Order ---------------- */
document.getElementById("order-form").addEventListener("submit", async ev => {
  ev.preventDefault();
  if (!cartItems.length) return showAlert("error", "Your cart is empty!");

  const orderId = "WF" + Date.now();
  const order = {
    orderId,
    name: document.getElementById("name").value,
    phone: document.getElementById("phone").value,
    region: regionEl.value,
    district: districtEl.value,
    upazila: upazilaEl.value,
    address: document.getElementById("address").value,
    paymentMethod: document.getElementById("payment-method").value,
    paymentChannel: document.getElementById("payment-channel").value,
    senderNumber: document.getElementById("sender-number").value,
    transactionId: document.getElementById("transaction-id").value,
    cartItems,
    discount: currentDiscount,
    timestamp: new Date().toISOString(),
  };

  placeOrderBtn.disabled = true;
  placeOrderBtn.textContent = "Processing...";

  try {
    // 1. Send to Google Sheet
    const scriptURL = "https://script.google.com/macros/s/AKfycby7NeSZ7siDOzIsDeVwffxEEyiCAMHMI0kJENCp1218aD9KnUxGWL7XjQ1Y80RbgIkApA/exec";
    await fetch(scriptURL, { method: "POST", body: JSON.stringify(order), headers: { "Content-Type": "application/json" } });

    // 2. Save Order to Firestore
    await setDoc(doc(db, "artifacts/WideFind/public/data/Orders", orderId), order);

    // 3. Update Coupon Usage & Auto-Deactivate
    if (appliedCoupon && appliedCoupon.code) {
      try {
        const couponRef = doc(db, "artifacts/WideFind/public/data/config/coupons");
        const snap = await getDoc(couponRef);

        if (snap.exists()) {
          const data = snap.data();
          const updatedCodes = (data.validCodes || []).map(c => {
            if (c.code === appliedCoupon.code) {
              const newUsedCount = (c.used || 0) + 1;
              const limit = Number(c.usageLimit) || 999999;
              return {
                ...c,
                used: newUsedCount,
                status: newUsedCount >= limit ? "inactive" : (c.status || "active")
              };
            }
            return c;
          });
          await setDoc(couponRef, { ...data, validCodes: updatedCodes }, { merge: true });
        }
      } catch (err) {
        console.error("Coupon Sync Error:", err);
      }
    }

    // 4. Final Success Actions
    localStorage.removeItem(CART_STORAGE_KEY);
    showAlert("success", `‚úÖ Order placed successfully! ID: ${orderId}`);
    setTimeout(() => window.location.href = SUCCESS_REDIRECT_URL, 2000);

  } catch (err) {
    console.error(err);
    showAlert("error", "‚ùå Failed to save order!");
  } finally {
    placeOrderBtn.disabled = false;
    placeOrderBtn.textContent = "Place Order";
  }
});

/* ---------------- Cancel Order ---------------- */
cancelOrderBtn.addEventListener("click", () => {
  if (confirm("Are you sure you want to cancel this order?")) {
    showAlert("error", "‚ùå Order cancelled ‚Äî returning to cart...");
    setTimeout(() => window.location.href = "cart.html", 1500);
  }
});
</script>


</body>
</html>








