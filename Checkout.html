<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - WideFind</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        
        /* Logo Animation */
        .logo-gradient {
            background: linear-gradient(90deg, #FFD700, #FFA500, #FF8C00, #FFD700);
            background-size: 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shine 3s linear infinite;
        }
        
        @keyframes shine {
            0% { background-position: 0%; }
            100% { background-position: 300%; }
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-left: 4px solid #ff6600;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s ease;
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast.success {
            border-left-color: #10B981;
        }
        
        .toast.error {
            border-left-color: #EF4444;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- ============================================
         HEADER SECTION
         ============================================ -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="index.html" class="flex items-center">
                    <h1 class="text-2xl md:text-3xl font-black logo-gradient tracking-tight">WideFind</h1>
                </a>
                
                <a href="cart.html" class="px-4 md:px-6 py-2 bg-gray-800 hover:bg-black text-white rounded-xl font-bold transition text-sm md:text-base">
                    <i class="fas fa-arrow-left mr-2"></i>
                    <span class="hidden sm:inline">Back to </span>Cart
                </a>
            </div>
        </div>
    </header>

    <!-- ============================================
         CHECKOUT FORM
         ============================================ -->
    <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <form id="checkout-form" class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <h2 class="text-3xl font-black text-gray-900 mb-8 text-center">Complete Your Order</h2>
            
            <!-- ============================================
                 CUSTOMER INFORMATION
                 ============================================ -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4 pb-2 border-b-2 border-orange-600">
                    Delivery & Contact Information
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="customer-name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none transition"
                               placeholder="Enter your full name"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Phone Number *</label>
                        <input type="tel" id="customer-phone" required pattern="[0-9]{11}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none transition"
                               placeholder="01XXXXXXXXX"
                        />
                    </div>
                </div>
                
                <!-- Region / District / Upazila Cascading Dropdowns -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Region *</label>
                        <select id="region" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none transition">
                            <option value="">Select Region</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">District *</label>
                        <select id="district" required disabled
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none transition">
                            <option value="">Select District</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Upazila *</label>
                        <select id="upazila" required disabled
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none transition">
                            <option value="">Select Upazila</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Full Delivery Address *</label>
                    <textarea id="customer-address" required rows="3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none transition"
                              placeholder="House/Apartment, Street, Landmarks..."
                    ></textarea>
                </div>
            </div>

            <!-- ============================================
                 COUPON CODE SECTION
                 ============================================ -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4 pb-2 border-b-2 border-orange-600">
                    Coupon Code
                </h3>
                
                <div class="flex gap-3">
                    <div class="flex-grow">
                        <input type="text" id="coupon-code"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none transition"
                               placeholder="Enter coupon code"
                        />
                        <p id="coupon-status" class="text-sm mt-2"></p>
                    </div>
                    <button type="button" id="apply-coupon-btn"
                            class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold transition">
                        Apply
                    </button>
                </div>
            </div>

            <!-- ============================================
                 ORDER SUMMARY
                 ============================================ -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4 pb-2 border-b-2 border-orange-600">
                    Order Summary
                </h3>
                
                <div id="order-items-list" class="mb-4 space-y-3">
                    <!-- Order items will be rendered here -->
                </div>
                
                <!-- Price Breakdown -->
                <div class="border-t-2 border-gray-200 pt-4 space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Items Subtotal:</span>
                        <span class="font-bold" id="items-subtotal">৳0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Delivery Charge:</span>
                        <span class="font-bold" id="delivery-charge">৳0</span>
                    </div>
                    <div class="text-xs text-gray-500 italic mb-2">
                        ⚠️ Delivery charge varies by region (Pathao Courier Service)
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-green-600">Discount:</span>
                        <span class="font-bold text-green-600" id="discount-amount">-৳0</span>
                    </div>
                    <div class="flex justify-between text-xl font-black pt-3 border-t border-gray-200">
                        <span>Grand Total:</span>
                        <span class="text-orange-600" id="grand-total">৳0</span>
                    </div>
                </div>
            </div>

            <!-- ============================================
                 PAYMENT METHOD
                 ============================================ -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4 pb-2 border-b-2 border-orange-600">
                    Payment Method
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <button type="button" class="payment-method-btn active" data-method="Cash on Delivery">
                        <i class="fas fa-money-bill-wave mr-2"></i>
                        Cash on Delivery (COD)
                    </button>
                    <button type="button" class="payment-method-btn" data-method="Online Payment">
                        <i class="fas fa-mobile-alt mr-2"></i>
                        Bkash / Nagad
                    </button>
                </div>
                <input type="hidden" id="payment-method" value="Cash on Delivery">
                
                <!-- Online Payment Fields (Hidden by default) -->
                <div id="online-payment-fields" class="hidden border-2 border-dashed border-orange-300 bg-orange-50 p-6 rounded-xl">
                    <p class="text-lg font-bold text-orange-800 mb-3">Complete Mobile Payment</p>
                    <div class="bg-orange-100 p-4 rounded-xl mb-4 text-center">
                        <span class="text-2xl font-black text-orange-700">01729789847</span>
                        <span class="block text-sm text-gray-600 font-semibold">(Bkash/Nagad Merchant)</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button type="button" class="payment-channel-btn" data-channel="Bkash">
                            <i class="fas fa-mobile-alt mr-2"></i> Bkash
                        </button>
                        <button type="button" class="payment-channel-btn" data-channel="Nagad">
                            <i class="fas fa-mobile-alt mr-2"></i> Nagad
                        </button>
                    </div>
                    <input type="hidden" id="payment-channel">
                    
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Your Mobile Number (Sender)</label>
                        <input type="text" id="sender-number" placeholder="01XXXXXXXXX"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl outline-none focus:ring-2 focus:ring-orange-500"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Transaction ID</label>
                        <input type="text" id="transaction-id" placeholder="ABC123XYZ"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl outline-none focus:ring-2 focus:ring-orange-500"
                        />
                    </div>
                </div>
            </div>

            <!-- ============================================
                 ACTION BUTTONS
                 ============================================ -->
            <div class="flex flex-col md:flex-row gap-4">
                <button type="submit" id="place-order-btn"
                        class="flex-1 py-4 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-bold text-lg transition">
                    <i class="fas fa-check-circle mr-2"></i>
                    Place Order
                </button>
                <button type="button" id="cancel-order-btn"
                        class="flex-1 py-4 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold text-lg transition">
                    <i class="fas fa-times-circle mr-2"></i>
                    Cancel Order
                </button>
            </div>
        </form>
    </main>

    <!-- ============================================
         FOOTER
         ============================================ -->
    <footer class="bg-white border-t border-gray-200 py-6 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-gray-600 text-sm">&copy; 2025 WideFind. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- ============================================
         FIREBASE & JAVASCRIPT
         ============================================ -->
    <script type="module">
        // ==========================================
        // FIREBASE CONFIGURATION
        // ==========================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFsnU6n1-ag1XB8QgJcj5rqjWHxaJ71v8",
            authDomain: "my-ecom-site-168ab.firebaseapp.com",
            projectId: "my-ecom-site-168ab",
            storageBucket: "my-ecom-site-168ab.firebasestorage.app",
            messagingSenderId: "995581566071",
            appId: "1:995581566071:web:1640d0236302d369aefa72"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = "WideFind";
        const CART_STORAGE_KEY = 'widefindCart';

        // ==========================================
        // GLOBAL VARIABLES
        // ==========================================
        let cartItems = [];
        let availableCoupons = [];
        let appliedCoupon = null;
        let currentDiscount = 0;
        let GEO_DATA = {};

        // Regional Delivery Fees (in BDT)
        const DELIVERY_FEES_BY_REGION = {
            "Dhaka": 80,
            "Chattogram": 100,
            "Rajshahi": 120,
            "Khulna": 120,
            "Sylhet": 110,
            "Rangpur": 130,
            "Barishal": 130,
            "Mymensingh": 120
        };

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        
        /**
         * Get cart from localStorage
         */
        function getCart() {
            try {
                return JSON.parse(localStorage.getItem(CART_STORAGE_KEY) || "[]");
            } catch (e) {
                return [];
            }
        }

        /**
         * Show toast notification
         */
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? 'fas fa-check-circle text-green-600' : 
                        type === 'error' ? 'fas fa-times-circle text-red-600' : 
                        'fas fa-info-circle text-orange-600';
            
            toast.innerHTML = `
                <i class="${icon} text-xl"></i>
                <span class="font-semibold text-gray-900">${message}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3500);
        }

        // ==========================================
        // LOAD BANGLADESH GEO DATA
        // ==========================================
        async function loadGeoData() {
            try {
                const response = await fetch('geo_data.json');
                GEO_DATA = await response.json();
                populateRegions();
            } catch (error) {
                console.error('Error loading geo data:', error);
                showToast('Failed to load location data', 'error');
            }
        }

        /**
         * Populate region dropdown
         */
        function populateRegions() {
            const regionSelect = document.getElementById('region');
            regionSelect.innerHTML = '<option value="">Select Region</option>';
            
            Object.keys(GEO_DATA).forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });
        }

        /**
         * Populate district dropdown based on selected region
         */
        function populateDistricts() {
            const region = document.getElementById('region').value;
            const districtSelect = document.getElementById('district');
            const upazilaSelect = document.getElementById('upazila');
            
            districtSelect.innerHTML = '<option value="">Select District</option>';
            upazilaSelect.innerHTML = '<option value="">Select Upazila</option>';
            upazilaSelect.disabled = true;
            
            if (!region) {
                districtSelect.disabled = true;
                return;
            }
            
            districtSelect.disabled = false;
            
            Object.keys(GEO_DATA[region]).forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
            
            // Update delivery fee
            updateOrderSummary();
        }

        /**
         * Populate upazila dropdown based on selected district
         */
        function populateUpazilas() {
            const region = document.getElementById('region').value;
            const district = document.getElementById('district').value;
            const upazilaSelect = document.getElementById('upazila');
            
            upazilaSelect.innerHTML = '<option value="">Select Upazila</option>';
            
            if (!region || !district) {
                upazilaSelect.disabled = true;
                return;
            }
            
            upazilaSelect.disabled = false;
            
            GEO_DATA[region][district].forEach(upazila => {
                const option = document.createElement('option');
                option.value = upazila;
                option.textContent = upazila;
                upazilaSelect.appendChild(option);
            });
        }

        // Event listeners for cascading dropdowns
        document.getElementById('region').addEventListener('change', populateDistricts);
        document.getElementById('district').addEventListener('change', populateUpazilas);

        // ==========================================
        // LOAD COUPONS FROM FIREBASE
        // ==========================================
        async function loadCoupons() {
            try {
                const couponRef = doc(db, `artifacts/${appId}/public/data/config/coupons`);
                const snap = await getDoc(couponRef);
                availableCoupons = snap.exists() ? (snap.data().validCodes || []) : [];
            } catch (error) {
                console.error('Error loading coupons:', error);
            }
        }

        // ==========================================
        // COUPON VALIDATION & APPLICATION
        // ==========================================
        document.getElementById('apply-coupon-btn').addEventListener('click', async () => {
            const couponCode = document.getElementById('coupon-code').value.trim().toUpperCase();
            const statusEl = document.getElementById('coupon-status');
            
            if (!couponCode) {
                showToast('Please enter a coupon code', 'error');
                return;
            }
            
            // Find matching coupon
            const coupon = availableCoupons.find(c => c.code && c.code.toUpperCase() === couponCode);
            
            // Check if coupon exists and is active
            if (!coupon || coupon.status !== 'active') {
                currentDiscount = 0;
                appliedCoupon = null;
                statusEl.innerHTML = '<span class="text-red-600 font-bold">❌ Invalid or inactive coupon</span>';
                showToast('Coupon is invalid or deactivated', 'error');
                updateOrderSummary();
                return;
            }
            
            // Check usage limit
            const usageLimit = Number(coupon.usageLimit) || 999999;
            const timesUsed = Number(coupon.used) || 0;
            
            if (timesUsed >= usageLimit && usageLimit !== 0) {
                currentDiscount = 0;
                appliedCoupon = null;
                statusEl.innerHTML = '<span class="text-red-600 font-bold">❌ Coupon has reached usage limit</span>';
                showToast('This coupon has expired', 'error');
                updateOrderSummary();
                return;
            }
            
            // Check minimum spend
            const itemsTotal = cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const minRequired = Number(coupon.minSpendRequired) || 0;
            
            if (itemsTotal < minRequired) {
                currentDiscount = 0;
                appliedCoupon = null;
                statusEl.innerHTML = `<span class="text-red-600 font-bold">❌ Minimum spend of ৳${minRequired} required. Add ৳${minRequired - itemsTotal} more.</span>`;
                showToast(`Minimum spend of ৳${minRequired} required!`, 'error');
                updateOrderSummary();
                return;
            }
            
            // Calculate discount
            currentDiscount = coupon.type === 'percent' 
                ? Math.round(itemsTotal * (coupon.amount / 100))
                : coupon.amount;
            
            appliedCoupon = coupon;
            statusEl.innerHTML = `<span class="text-green-600 font-bold">✅ Coupon applied! Saved ৳${currentDiscount}</span>`;
            showToast(`✅ ৳${currentDiscount} discount applied!`, 'success');
            updateOrderSummary();
        });

        // ==========================================
        // CALCULATE TOTALS
        // ==========================================
        function calculateTotals() {
            const itemsTotal = cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const region = document.getElementById('region').value;
            const deliveryFee = DELIVERY_FEES_BY_REGION[region] || 80;
            const discount = currentDiscount || 0;
            const grandTotal = Math.max(itemsTotal + deliveryFee - discount, 0);
            
            return { itemsTotal, deliveryFee, discount, grandTotal };
        }

        // ==========================================
        // UPDATE ORDER SUMMARY
        // ==========================================
        function updateOrderSummary() {
            // Render cart items
            const itemsList = document.getElementById('order-items-list');
            itemsList.innerHTML = cartItems.map(item => `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">${item.name} ${item.size && item.size !== 'Standard' ? `(${item.size})` : ''} × ${item.qty}</span>
                    <span class="font-bold">৳${(item.price * item.qty).toFixed(0)}</span>
                </div>
            `).join('');
            
            // Update totals
            const { itemsTotal, deliveryFee, discount, grandTotal } = calculateTotals();
            
            document.getElementById('items-subtotal').textContent = `৳${itemsTotal.toFixed(0)}`;
            document.getElementById('delivery-charge').textContent = `৳${deliveryFee.toFixed(0)}`;
            document.getElementById('discount-amount').textContent = `-৳${discount.toFixed(0)}`;
            document.getElementById('grand-total').textContent = `৳${grandTotal.toFixed(0)}`;
        }

        // ==========================================
        // PAYMENT METHOD SELECTION
        // ==========================================
        document.querySelectorAll('.payment-method-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Remove active class from all buttons
                document.querySelectorAll('.payment-method-btn').forEach(b => b.classList.remove('active'));
                
                // Add active class to clicked button
                e.currentTarget.classList.add('active');
                
                const method = e.currentTarget.dataset.method;
                document.getElementById('payment-method').value = method;
                
                // Show/hide online payment fields
                const onlineFields = document.getElementById('online-payment-fields');
                if (method === 'Online Payment') {
                    onlineFields.classList.remove('hidden');
                    document.getElementById('sender-number').required = true;
                    document.getElementById('transaction-id').required = true;
                } else {
                    onlineFields.classList.add('hidden');
                    document.getElementById('sender-number').required = false;
                    document.getElementById('transaction-id').required = false;
                }
            });
        });

        // Payment channel selection
        document.querySelectorAll('.payment-channel-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.payment-channel-btn').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                
                const channel = e.currentTarget.dataset.channel;
                document.getElementById('payment-channel').value = channel;
                showToast(`${channel} selected`, 'success');
            });
        });

        // ==========================================
        // PLACE ORDER
        // ==========================================
        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!cartItems.length) {
                showToast('Your cart is empty', 'error');
                return;
            }
            
            const orderId = "WF" + Date.now();
            const { itemsTotal, deliveryFee, discount, grandTotal } = calculateTotals();
            
            const orderData = {
                orderId,
                name: document.getElementById('customer-name').value,
                phone: document.getElementById('customer-phone').value,
                region: document.getElementById('region').value,
                district: document.getElementById('district').value,
                upazila: document.getElementById('upazila').value,
                address: document.getElementById('customer-address').value,
                paymentMethod: document.getElementById('payment-method').value,
                paymentChannel: document.getElementById('payment-channel').value || '',
                senderNumber: document.getElementById('sender-number').value || '',
                transactionId: document.getElementById('transaction-id').value || '',
                cartItems: cartItems,
                itemsTotal: itemsTotal,
                deliveryCharge: deliveryFee,
                discount: discount,
                grandTotal: grandTotal,
                status: 'Pending',
                timestamp: new Date().toISOString()
            };
            
            const placeOrderBtn = document.getElementById('place-order-btn');
            placeOrderBtn.disabled = true;
            placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
            
            try {
                // 1. Save order to Firestore
                const cleanOrder = JSON.parse(JSON.stringify(orderData));
                await setDoc(doc(db, `artifacts/${appId}/public/data/Orders`, orderId), cleanOrder);
                
                // 2. Reduce product stock
                try {
                    const stockUpdates = cartItems.map(item => {
                        const productRef = doc(db, `artifacts/${appId}/public/data/products/${item.sku}`);
                        return updateDoc(productRef, {
                            stock: increment(-Number(item.qty))
                        });
                    });
                    await Promise.all(stockUpdates);
                } catch (stockError) {
                    console.error('Stock update error:', stockError);
                    // Continue anyway - order is already placed
                }
                
                // 3. Update coupon usage (if applied)
                if (appliedCoupon && appliedCoupon.code) {
                    try {
                        const couponRef = doc(db, `artifacts/${appId}/public/data/config/coupons`);
                        const snap = await getDoc(couponRef);
                        
                        if (snap.exists()) {
                            const updatedCodes = (snap.data().validCodes || []).map(c => {
                                if (c.code === appliedCoupon.code) {
                                    const newUsedCount = (c.used || 0) + 1;
                                    const limit = Number(c.usageLimit) || 999999;
                                    return {
                                        ...c,
                                        used: newUsedCount,
                                        status: newUsedCount >= limit ? "inactive" : (c.status || "active")
                                    };
                                }
                                return c;
                            });
                            await setDoc(couponRef, { validCodes: updatedCodes }, { merge: true });
                        }
                    } catch (couponError) {
                        console.error('Coupon update error:', couponError);
                        // Continue anyway - order is already placed
                    }
                }
                
                // 4. Send to Google Sheets (background, no await)
                const scriptURL = "https://script.google.com/macros/s/AKfycby7NeSZ7siDOzIsDeVwffxEEyiCAMHMI0kJENCp1218aD9KnUxGWL7XjQ1Y80RbgIkApA/exec";
                fetch(scriptURL, { 
                    method: "POST", 
                    body: JSON.stringify(orderData), 
                    mode: 'no-cors' 
                }).catch(e => console.log("Sheet submission backgrounded"));
                
                // 5. Clear cart and redirect
                localStorage.removeItem(CART_STORAGE_KEY);
                showToast(`✅ Order placed successfully! ID: ${orderId}`, 'success');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                
            } catch (error) {
                console.error('Full order submission error:', error);
                console.error('Error details:', error.message);
                console.error('Error code:', error.code);
                showToast('Failed to place order. Please check your connection and try again.', 'error');
                placeOrderBtn.disabled = false;
                placeOrderBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Place Order';
            }
        });

        // ==========================================
        // CANCEL ORDER
        // ==========================================
        document.getElementById('cancel-order-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to cancel this order?')) {
                showToast('Order cancelled', 'error');
                setTimeout(() => window.location.href = 'cart.html', 1500);
            }
        });

        // ==========================================
        // INITIALIZE ON PAGE LOAD
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Load cart items
            cartItems = getCart();
            
            // If cart is empty, redirect to cart page
            if (!cartItems.length) {
                showToast('Your cart is empty', 'error');
                setTimeout(() => window.location.href = 'cart.html', 1800);
                return;
            }
            
            // Load geo data
            await loadGeoData();
            
            // Load coupons
            await loadCoupons();
            
            // Render order summary
            updateOrderSummary();
        });
    </script>

    <style>
        /* Payment Method Button Styles */
        .payment-method-btn {
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-weight: 600;
            background: #f9fafb;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-method-btn:hover {
            border-color: #ff6600;
            background: #fff;
        }
        
        .payment-method-btn.active {
            border-color: #ff6600;
            background: #fff5ee;
            color: #ff6600;
        }
        
        /* Payment Channel Button Styles */
        .payment-channel-btn {
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-weight: 600;
            background: #f9fafb;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-channel-btn:hover {
            border-color: #ff6600;
        }
        
        .payment-channel-btn.active {
            border-color: #ff6600;
            background: #ff6600;
            color: white;
        }
    </style>
</body>
</html>
