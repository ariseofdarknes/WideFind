<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. Firebase Configuration (Matches your Admin Panel)
    const firebaseConfig = {
        apiKey: "AIzaSyDFsnU6n1-ag1XB8QgJcj5rqjWHxaJ71v8",
        authDomain: "my-ecom-site-168ab.firebaseapp.com",
        projectId: "my-ecom-site-168ab",
        storageBucket: "my-ecom-site-168ab.appspot.com",
        messagingSenderId: "995581566071",
        appId: "1:995581566071:web:1640d0236302d369aefa72",
        measurementId: "G-NLHKNBHCFN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const appId = "WideFind";
    const CART_STORAGE_KEY = 'widefindCart';

    // 2. Helper Functions
    function getValidImageURL(url) {
        if (!url) return "https://placehold.co/400x300?text=No+Image";
        if (url.includes("imgur.com") && !url.includes("i.imgur.com")) {
            const match = url.match(/imgur\.com\/(?:a\/|gallery\/)?([A-Za-z0-9]+)/);
            if (match && match[1]) return `https://i.imgur.com/${match[1]}.jpg`;
        }
        return url;
    }

    function updateCartCount() {
        try {
            const cart = JSON.parse(localStorage.getItem(CART_STORAGE_KEY) || "[]");
            const totalItems = cart.reduce((sum, item) => sum + (Number(item.qty) || 0), 0);
            document.getElementById('cart-count').textContent = totalItems;
        } catch (e) { console.error('Cart count error:', e); }
    }

    function showToast(message) {
        const toast = document.getElementById('custom-toast');
        const msg = document.getElementById('toast-msg');
        if (toast && msg) {
            msg.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    }

    function addToCart(product) {
        try {
            let cart = JSON.parse(localStorage.getItem(CART_STORAGE_KEY) || "[]");
            const existing = cart.find(item => item.id === product.id);
            if (existing) {
                existing.qty = (Number(existing.qty) || 0) + 1;
            } else {
                cart.push({ ...product, qty: 1 });
            }
            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
            updateCartCount();
            showToast(`${product.name} added to cart!`);
        } catch (e) { console.error("Add to cart error:", e); }
    }

    // 3. Data Loading Functions
    async function loadSiteSettings() {
        try {
            const settingsRef = doc(db, `artifacts/${appId}/public/data/config/siteSettings`);
            const snap = await getDoc(settingsRef);
            if (snap.exists()) {
                const settings = snap.data();
                const categories = settings.categoryList || ['Popular','T-Shirt','Sunglass','Watch'];
                const menu = document.getElementById('category-menu');
                menu.innerHTML = '<a href="#" class="category-item active" data-category="popular">Popular</a>';
                categories.forEach(cat => {
                    if (cat.toLowerCase() !== 'popular') {
                        const link = document.createElement('a');
                        link.href = '#';
                        link.className = 'category-item';
                        link.dataset.category = cat;
                        link.textContent = cat;
                        menu.appendChild(link);
                    }
                });
                
                const banners = settings.adBanners || [];
                const bannerSlider = document.getElementById('banner-slider');
                if (banners.length > 0) {
                    bannerSlider.innerHTML = '';
                    banners.forEach((banner, index) => {
                        const slide = document.createElement('div');
                        slide.className = `banner-slide ${index === 0 ? 'active' : ''}`;
                        slide.style.backgroundImage = `url('${banner.img}')`;
                        bannerSlider.appendChild(slide);
                    });
                }
            }
        } catch (e) { console.error('Settings error:', e); }
    }

    async function loadProducts(category = "popular") {
        const container = document.getElementById('product-list-container');
        const title = document.getElementById('product-section-title');
        container.innerHTML = '<p style="text-align:center;grid-column:1/-1;color:#999;padding:40px;">Loading products...</p>';

        try {
            const productsRef = collection(db, `artifacts/${appId}/public/data/products`);
            const snapshot = await getDocs(productsRef);
            let products = [];
            snapshot.forEach(doc => products.push({ id: doc.id, ...doc.data() }));

            if (category === "popular") {
                products = products.filter(p => p.isPopular === true);
                title.textContent = "Popular Products";
            } else {
                products = products.filter(p => p.category === category);
                title.textContent = `${category} Collection`;
            }

            container.innerHTML = '';
            products.forEach(product => {
                let displayPercent = product.discountPercent ? Math.round(Number(product.discountPercent)) : 0;
                let firstImage = Array.isArray(product.images) ? product.images[0] : (product.images || '').split(',')[0].trim();

                const card = document.createElement("div");
                card.className = "product-card";
                card.innerHTML = `
                    <a href="product.html?id=${product.id}" style="text-decoration:none; color:inherit;">
                        <img src="${getValidImageURL(firstImage)}" alt="${product.name}">
                        <h3>${product.name}</h3>
                        <div class="price-container">
                            <span class="sale-price">৳${Number(product.price||0).toFixed(0)}</span>
                            ${product.originalPrice ? `<span class="original-price">৳${Number(product.originalPrice).toFixed(0)}</span>` : ''}
                            ${displayPercent > 0 ? `<span class="discount-percent">-${displayPercent}%</span>` : ''}
                        </div>
                    </a>
                    <button class="btn-buy add-to-cart-btn" data-id="${product.id}" style="width:100%; margin-top:10px; border:none; cursor:pointer;">
                        Add to Cart
                    </button>
                `;
                
                // Add click event specifically for the button
                card.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    addToCart(product);
                });

                container.appendChild(card);
            });
        } catch (e) { console.error('Product loading error:', e); }
    }

    // 4. Initialize
    document.addEventListener("DOMContentLoaded", () => {
        updateCartCount();
        loadSiteSettings();
        loadProducts("popular");

        document.getElementById('category-menu').addEventListener('click', (e) => {
            if (e.target.classList.contains('category-item')) {
                e.preventDefault();
                document.querySelectorAll(".category-item").forEach(b => b.classList.remove("active"));
                e.target.classList.add("active");
                loadProducts(e.target.dataset.category);
            }
        });
        window.addEventListener('focus', updateCartCount);
    });
</script>

<style>
  .floating-support { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
  .support-btn { display: block; padding: 12px 18px; font-size: 14px; font-weight: 600; color: #fff; border-radius: 8px; text-decoration: none; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.25); transition: 0.25s; }
  .whatsapp { background: #25D366; }
  .facebook { background: #1877f2; }
  
  #custom-toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 12px 24px; border-radius: 50px; display: flex; align-items: center; gap: 10px; opacity: 0; visibility: hidden; transition: 0.4s; z-index: 10000; border: 1px solid #ff0000; }
  #custom-toast.show { opacity: 1; visibility: visible; bottom: 120px; }
</style>

<div class="floating-support">
  <a href="https://wa.me/8801729789847" target="_blank" class="support-btn whatsapp">WhatsApp Support</a>
  <a href="https://facebook.com/widefind" target="_blank" class="support-btn facebook">Facebook Page</a>
</div>

<div id="custom-toast">
    <span style="color: #ff0000;">✔</span> <span id="toast-msg">Added to cart</span>
</div>
</body>
</html>
